<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>raw wasm: making a maze race, part 1</title>
    <meta name="Description" content="">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/prism-ghcolors.css">

    <!-- copy-pasted favicon stuff from http://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

  </head>

  <body>
    <header class="site-header" role="banner">
      <div class="wrapper header-wrapper">
        <img class="site-binji-img" src="https://binji.github.io//assets/benji-banner-4x.png"></img>
        <a class="site-title" href="/">binji&#39;s dustbin</a>

        <nav class="site-nav">
          <div class="trigger">
            
              
              <a class="page-link" href="/about/">about</a>
              
            
          </div>
        </nav>
      </div>

    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">raw wasm: making a maze race, part 1</h1>
    
    <p class="post-meta"><time datetime="20 Oct 2019" itemprop="datePublished">20 Oct 2019</time></p>
    
  </header>

  <div class="post-content" itemprop="articleBody">
    <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<h1>Raw wasm</h1>
<p>For the past year or so, I've been making fun little demos that I've written in
WebAssembly. Unlike most other assembly languages, WebAssembly wasn't designed
to be written by hand, and it shows ‚Äî there are a lot of things that make it
frustrating for a person to write. On the other hand, just like other assembly
languages, the fact that it's hard to do makes it fun!</p>
<p>The first demo I made like this was a <a href="htts://binji.github.io/raw-wasm/doomfire">doomfire demo</a>, which uses the
technique described in <a href="http://fabiensanglard.net/doom_fire_psx/index.html">Fabien Sanglard's blog</a>. It is all
contained in a single <a href="https://github.com/binji/raw-wasm/blob/master/doomfire/index.html">HTML file</a>, including the contents of
the WebAssembly binary file, stored as an array of bytes.</p>
<p>I didn't write the binary by hand, instead I wrote using the <a href="http://webassembly.github.io/spec/core/text/index.html">WebAssembly text
format</a> (<code>.wat</code>), and used the <a href="https://github.com/WebAssembly/wabt">wat2wasm</a> tool to convert it. The text
format uses an <a href="https://en.wikipedia.org/wiki/S-expression">s-expression</a>-like format, but otherwise doesn't work much
like lisp. Here's a brief snippet from the <a href="https://github.com/binji/raw-wasm/blob/master/doomfire/fire.wat#L24">doomfire demo</a>:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$setup</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; Fill bottom row with color 36, (R=0xff, G=0xff, B=0xff).</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$i</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">320</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token comment">;; memory[53440 - 1 + i] = 36</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">53439</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token comment">;; loop if --i != 0</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token number">0</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$i</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>This function is run once at the beginning, and fills the bottom of the screen
with the color 36, which is all white. The fire is drawn from bottom to top,
fading from bright white, through to yellows, and oranges, then reds, dark
reds, and finally to black. Again, take a look at <a href="http://fabiensanglard.net/doom_fire_psx/index.html">Fabien's blog</a> for more details.</p>
<p>The relevant part for us is how WebAssembly looks. You can see a single <code>loop</code>,
a local index variable <code>$i</code>, writing a byte to memory with the <code>i32.store8</code>
instruction, and performing a conditional branch with the <code>br_if</code> instruction.</p>
<p>The code written above is equivalent to the following C-like code, hinted at
by the comments:</p>
<pre class="language-c"><code class="language-c"><span class="highlight-line"><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  uint32_t i <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">do</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    memory<span class="token punctuation">[</span><span class="token number">53440</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>The magic number 53440 here is the bottom row of pixels, where each pixel here
is a palette index (not the final RGBA color). The WebAssembly memory layout
for this demo is described in the source code above:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; 5 pages * 64KiB bytes per page:</span></span><br><span class="highlight-line"><span class="token comment">;; [0, 53760)       => firePixels, 1 byte per pixel.</span></span><br><span class="highlight-line"><span class="token comment">;; [53760, 268800)  => canvasData, 4 bytes per pixel.</span></span><br><span class="highlight-line"><span class="token comment">;; [268800, 268948) => Palette data, RGBA.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"mem"</span><span class="token punctuation">)</span> <span class="token number">5</span><span class="token punctuation">)</span></span></code></pre>
<p>Unlike other assembly languages, the WebAssembly text format doesn't allow you
to provide nice names for memory locations. So you'll have to use raw numbers
instead.</p>
<p>This demo has one more function to update the flames, which runs once per
frame in a <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">requestAnimationFrame</a> callback. The final <code>.wat</code> file is 107
lines, of code. Converting this from text to binary produces a 398 byte <code>.wasm</code>
file, which I've embedded directly into the HTML. Here's the final result:</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="https://binji.github.io/raw-wasm/doomfire/"></iframe>
  </div>
</div>
<p>I made this demo back in May. After I did, my colleague <a href="https://twitter.com/billb">Bill</a> told me I
should call it &quot;raw&quot; wasm, which I thought was a fun name. Since then, I've
made a few other demos:</p>
<ul>
<li>A <a href="https://binji.github.io/raw-wasm/metaball">metaball demo</a> in <strong>452 bytes</strong></li>
<li>A <a href="https://binji.github.io/raw-wasm/raytrace">raytracer</a> with 4 spheres, 1 light, reflections and shadows in <strong>1486 bytes</strong></li>
<li>A <a href="https://binji.github.io/raw-wasm/snake">snake-like game</a>, but with 360¬∞ rotation in <strong>1976 bytes</strong></li>
</ul>
<p>You can find the source for all of these demos on GitHub in my <a href="https://github.com/binji/raw-wasm">raw-wasm
repo</a>. Just a warning though: I do this just for fun; real
WebAssembly shouldn't be written by hand!</p>
<p><a href="https://twitter.com/ColinEberhardt">Colin Eberhardt</a> even joined in to make one, loosely based on my metaball
demo!</p>
<div class="twitter">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Just for fun - here&#39;s a funky interference pattern hand coded in WebAssembly <a href="https://t.co/hbu9axEvtT">https://t.co/hbu9axEvtT</a> <br>Inspired by <a href="https://t.co/lXqFnP3d5t">https://t.co/lXqFnP3d5t</a> from <a href="https://twitter.com/binjimint?ref_src=twsrc%5Etfw">@binjimint</a> / <a href="https://twitter.com/torch2424?ref_src=twsrc%5Etfw">@torch2424</a> - and with the help of Aer Lingus and my flight delay üò≠ <a href="https://t.co/F36m109MJ2">pic.twitter.com/F36m109MJ2</a></p>&mdash; Colin Eberhardt (@ColinEberhardt) <a href="https://twitter.com/ColinEberhardt/status/1128701985757253632?ref_src=twsrc%5Etfw">May 15, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>For each of the demos, I made some rules for myself. I could import a few
helpful functions from JavaScript (<code>Math.sin</code>, <code>Math.random</code>), but it would be
cheating to use JavaScript for more than that. In general, I tried to make the
files as small as I could, without sacrificing too much readability. Each demo
has a <code>run()</code> function that expects to be called once per frame. They may have
other exported functions too, and the names of those are fair game (often I'll
export them as the empty string, which saves some bytes).</p>
<p>Usually after I finished a demo, I'd spend some time trying to make them a
little smaller, until I hit a goal (&quot;less than 2000 bytes!&quot;) or I got bored.
Usually, a few weeks later, I'd get inspired again and work on the next one.</p>
<h2>What's next?</h2>
<p>I finished the snake game back in June as part of a hack day with my friend
<a href="http://twitter.com/torch2424">Aaron</a> (who made an awesome wasm matrix demo that day!).</p>
<div class="twitter">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Super overdue on my Saturday Hack Day project, but here it is! üëçüèæ<br><br>What if I told you <a href="https://twitter.com/hashtag/AssemblyScript?src=hash&amp;ref_src=twsrc%5Etfw">#AssemblyScript</a> has WASI bindings, and Wasmer&#39;s new WAPM is a great for it? ü§î<br><br>So I built the matrix for <a href="https://twitter.com/hashtag/webassembly?src=hash&amp;ref_src=twsrc%5Etfw">#webassembly</a> üòéüñ•Ô∏èüéâ <br><br>`wapm install -g torch2424/wasm-matrix`<a href="https://t.co/cecBCdt8sw">https://t.co/cecBCdt8sw</a> <a href="https://t.co/vwVCvYP9Bu">pic.twitter.com/vwVCvYP9Bu</a></p>&mdash; Aaron Turner (@torch2424) <a href="https://twitter.com/torch2424/status/1129089108322578432?ref_src=twsrc%5Etfw">May 16, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>Each of my demos was getting more complex (and larger), and I wasn't sure what
I'd do next. My colleague <a href="https://twitter.com/wvo">Wouter</a> suggested I make a little Wolfenstein
3D-like demo. I have a copy of Fabien Sanglard's <a href="http://fabiensanglard.net/gebbwolf3d/">Game Engine Black Book on
Wolfenstein 3D</a>, so this seemed like a pretty good idea. But I
didn't have much time to work on it until earlier this month.</p>
<h2>Maze Race</h2>
<p>To make a Wolfenstein-like renderer, you do the following: For each column
(i.e. x-coordinate) of the screen, you fire a ray into the scene to find the
first wall you hit. When you hit a wall, you record the distance to it. To draw
the wall, you draw a vertical strip. The height of this strip is inversely
proportional to the distance to the wall. This way a distant wall is drawn
smaller than a close wall.</p>
<p><img src="/assets/2019-10-20-rendering.png" alt="wolf3d rendering"></p>
<p>Wolfenstein uses a trick to make this fast on old machines. Since each wall is
in a grid, we can find which wall we hit by stepping to each grid edge, and
finding the first grid cell that contains a wall.</p>
<p><img src="/assets/2019-10-20-grid-based.png" alt="wolf3d grid"></p>
<p>I could have done it this way, but machines are so fast these days, it isn't
really necessary. All we need to do is find an intersection between a ray (for
a given column of the screen) and a line segment (an infinitely thin wall).
This requires one divide, but that's not too expensive. Even if we brute-force
test every ray of a 320x240 screen against 100 walls, that's still just 32000
intersection tests, which is easy for a modern machine.</p>
<h3>Step 1: Ray-Line Segment Intersection</h3>
<p>I started off by implementing an intersection test between a ray and a line
segment. Instead of doing the math myself, I took the equation from
<a href="https://rootllama.wordpress.com/2014/06/20/ray-line-segment-intersection-test-in-2d/">rootllama's blog</a>:</p>
<p>$$
\begin{array}{lcl}
t_1 &amp;=&amp; \displaystyle\frac{|\textbf{v}_2 \times \textbf{v}_1|}{\textbf{v}_2 \cdot \textbf{v}_3} \\
t_2 &amp;=&amp; \displaystyle\frac{\textbf{v}_1 \cdot \textbf{v}_3}{\textbf{v}_2 \cdot \textbf{v}_3}
\end{array}
$$</p>
<p>where</p>
<p>$$
\begin{array}{lcl}
\textbf{v}_1 &amp;=&amp; \textbf{o} - \textbf{a} \\
\textbf{v}_2 &amp;=&amp; \textbf{b} - \textbf{a} \\
\textbf{v}_3 &amp;=&amp; (-\textbf{d}_y, \textbf{d}_x) \\
\end{array}
$$</p>
<p>given a ray with origin \(\textbf{o}\) and direction \(\textbf{d}\), and a line
segment with endpoints \(\textbf{a}\) and \(\textbf{b}\).</p>
<p>This yields two t values. \(\textbf{t}_1\) is the intersection &quot;time&quot; along the
ray, where 0 is at the origin, and positive values are the distance in the
direction of the ray. \(\textbf{t}_2\) is the intersection time on the line
segment, where 0 means the ray hit the segment at \(\textbf{a}\), and 1 means
the ray hit the segment at \(\textbf{b}\).</p>
<p>Given that, we can write this WebAssembly code:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v1x</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v1y</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v2x</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v2y</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v3x</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$v3y</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; v1 = O - a</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v1x</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$Ox</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$ax</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v1y</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$Oy</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$ay</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; v2 = b - a</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v2x</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bx</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$ax</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v2y</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$by</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$ay</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; v3 = (-dy, dx)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v3x</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>neg</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v3y</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Instead of doing two divides (for \(\textbf{v}_2 \cdot \textbf{v}_3\) , we can
instead take the reciprocal and multiply:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$inv-v2.v3</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$t2</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">...</span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$inv-v2.v3</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>div</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v2x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v3x</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v2y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v3y</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; t2 is intersection "time" between s and e.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$t2</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v1x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v3x</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v1y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v3y</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$inv-v2.v3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>It's OK if the dot product is zero; it just means that <code>$inv-v2.v3</code> and <code>$t2</code>
will be infinity. We then check whether <code>$t2</code> is between 0 and 1, inclusive. If
so, we calculate <code>$t1</code> and make sure it's greater than or equal to 0.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; t2 must be between [0, 1].</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>ge</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$t2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>le</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$t2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">    <span class="token comment">;; t1 is distance along ray.</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$t1</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v2x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v1y</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v1x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v2y</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$inv-v2.v3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    ...</span><br><span class="highlight-line">    <span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Note that the length of the cross product of \(\textbf{v}_2\) and \(\textbf{
v}_1\) (extended into 3d space) is the determinant of the matrix made from
those vectors:</p>
<p>$$
|\textbf{v}_2 \times \textbf{v}_1| =
\det{\begin{vmatrix} {v_2}_x &amp; {v_1}_x \\ {v_2}_y &amp; {v_1}_y \end{vmatrix} } =
{{v_2}_x}{{v_1}_y} - {{v_1}_x}{{v_2}_y}
$$</p>
<p><code>$t1</code> is the distance along the ray, so we can divide the screen height by this
value to get the height of the wall. This means that a wall that is one unit
away will be as tall as the screen. Here, I use half of the screen height (120
pixels) instead, which means <code>$height</code> will be half of the wall height. This is
done so we can measure from the middle of the screen.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$height</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32</span>.trunc_f32_s</span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>div</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span>     <span class="token comment">;; screen height / 2.</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$t1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">;; distance along ray</span></span></code></pre>
<h3>Step 2: Drawing a wall</h3>
<p>Now that we have the wall height, we need to draw the pixels for this column.
As a first test, it's easiest to just plot black for the ceiling and floor
(<code>0xff000000</code> RGB 0,0,0 with full alpha) and white for the wall (<code>0xffffffff</code>).</p>
<p>We have to make sure we don't write data out-of-bounds, which can happen when
we're very close to a wall. To do so, we need to clamp the top of the wall
(<code>$miny</code>) to 0 and the bottom of the wall (<code>$maxy</code>) to the screen height.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$miny</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$height</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$maxy</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$height</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; clamp miny and maxy</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>le_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$miny</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$miny</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>ge_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$maxy</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$maxy</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>If <code>$miny</code> is non-zero (i.e. we hit a wall), then we can loop from 0 down to
<code>$miny</code> to draw the ceiling, and from 240 up to <code>$maxy</code> to draw the floor. The
<code>$addr</code> and <code>$bot-addr</code> variables track the current pixel address for the
ceiling and floor respectively. The <code>0x3000</code> offset is the memory address of
the screen memory (for now, I ended up changing it later).</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$miny</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$miny</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">loop</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token comment">;; draw ceiling (increment after)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x3000</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$addr</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$addr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1280</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token comment">;; draw-floor (decrement before)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$bot-addr</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bot-addr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1280</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x3000</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bot-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">br_if</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<h3>Step 3: Shooting multiple rays</h3>
<p>To draw a full wall and not just a column, we need to fire multiple rays. Each
ray should start at the player location and point where the player is looking.</p>
<p>We need to decide what the field of view should be, and I arbitrarily picked
90¬∞. To calculate each ray's direction (\(\textbf{d}\)), we start with the
player's direction (\(\textbf{f}\)) and add (or subtract) a fraction of the
vector that is perpendicular to that direction:</p>
<p>$$ \textbf{d} = \textbf{f} + \frac{x - 160}{160} \textbf{f}_\perp $$</p>
<p><img src="/assets/2019-10-20-rays.png" alt="rays"></p>
<p>This means most rays will not have a length of 1. This is actually what we want
for projection. If we normalize the ray, we'll get curved walls instead.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; Loop for each column.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$x-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$xproj</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>div</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32</span>.convert_i32_s <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    ...</span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dx</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fx</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$xproj</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>neg</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fy</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dy</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fy</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$xproj</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$fx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    ...</span><br><span class="highlight-line">    <span class="token comment">;; Fire each ray; see whether we hit the wall.</span></span><br><span class="highlight-line">    <span class="token comment">;; Draw the floor, ceiling and wall for this column</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">;; loop on x</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$x-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$x</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">320</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Here's a demo of this in action! The code here also includes the ability to
move around, which requires a little extra wasm and javascript code.</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-20-one-wall.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">662 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-20-one-wall.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/ca4c52fa5917a7558b0775f8aad82313">(.wat source)</a>
  </div>
</div>
<p>Progress!</p>
<h3>Step 4: Multiple walls</h3>
<p>As mentioned above, we can handle multiple walls by firing a ray against each
one, and determining which hit is the closest.</p>
<p>This means we'll have to store each wall in an array. Let's create 4 walls to
start. Each one is stored as a <code>f32</code> value, but the WebAssembly text format
doesn't let us write that directly. Instead, we have to encode the values
manually. Using <a href="https://docs.python.org/3/library/struct.html">Python's struct library</a> helps:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> struct</span><br><span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'\\%02x'</span> <span class="token operator">%</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token number">12.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">\<span class="token number">00</span>\<span class="token number">00</span>\<span class="token number">40</span>\<span class="token number">41</span></span><br><span class="highlight-line"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'\\%02x'</span> <span class="token operator">%</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">\<span class="token number">00</span>\<span class="token number">00</span>\<span class="token number">40</span>\c1</span></code></pre>
<p>For now, we can write these walls starting at address 0. The four values are
the x and y coordinates of the wall's \(\textbf{a}\) and \(\textbf{b}\)
points:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; top wall</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; ax = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; ay = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; bx = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; by = +12.0</span></span><br><span class="highlight-line">  <span class="token comment">;; right wall</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; ax = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; ay = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; bx = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; by = -12.0</span></span><br><span class="highlight-line">  <span class="token comment">;; bottom wall</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; ax = +12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; ay = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; bx = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; by = -12.0</span></span><br><span class="highlight-line">  <span class="token comment">;; left wall</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; ax = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; ay = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\c1"</span>  <span class="token comment">;; bx = -12.0</span></span><br><span class="highlight-line">  <span class="token string">"\00\00\40\41"</span>  <span class="token comment">;; by = +12.0</span></span><br><span class="highlight-line"><span class="token punctuation">)</span></span></code></pre>
<p>Then we can add a loop over each wall, and record the minimum distance:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; Initialize the minimum distance, and the starting wall address.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$mindist</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">inf</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$wall</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; For each wall...</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$wall-</span><span class="token keyword">loop</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; Fire a ray against this wall.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dist</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$ray-line</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>load</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>load</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">4</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>load</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">8</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>load</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">12</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; Keep the smaller distance.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$mindist</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>min</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$mindist</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dist</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"> <span class="token comment">;; 4 walls * 0x10 bytes per wall</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$wall-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$wall</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Here's the updated demo with four walls. These walls are just visual for now,
they can't hold us back!</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-20-four-walls.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">726 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-20-four-walls.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/fea1d2e81e9c32c2829b156252cce43a">(.wat source)</a>
  </div>
</div>
<h3>Step 5: Texturing</h3>
<p>Let's give the walls some texture! First I created a 32 x 32 brick texture in
<a href="https://www.gimp.org/">gimp</a>:</p>
<img src="/assets/brick.png" width="256" height="256" style="image-rendering: pixelated;">
<p>I could include this directly in the wasm file, but it would add \(32 \times
32 \times 4\text{ bytes per pixel} = 4096\text{ bytes}\) bytes to the file!
Since it only has 4 colors, we can save space by storing it as 2
bits per pixel, and having a separate palette. That would reduce the size to:</p>
<p>$$
32 \times 32 \times \frac{2\text{ bits per pixel} }{8\text{ bits per byte} } = 256\text{ bytes} \\
4\text{ colors} \times 4\text{ bytes per color} = 16\text{ bytes}
$$</p>
<p>which is OK for now.</p>
<p>To convert the image, I wrote a little python script. Working with <a href="https://en.wikipedia.org/wiki/Netpbm_format">PPM</a>
image files is really easy since it's a text format:</p>
<pre><code>P3
# Created by GIMP version 2.10.12 PNM plug-in
32 32
255
0
0
0
...
</code></pre>
<p>It starts with a header, image width and height (32 and 32), the maximum
channel value (255), then has RGB values for each pixel.</p>
<p>So we can convert the pixel data with the following code:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># Read file contents</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Skip first 4 lines, convert the rest from string to int</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Helper function to group a list into tuples</span></span><br><span class="highlight-line">groupinto <span class="token operator">=</span> <span class="token keyword">lambda</span> l<span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Group int RGB tuples, e.g. [(0, 0, 0), (255, 255, 255), ...]</span></span><br><span class="highlight-line">data <span class="token operator">=</span> groupinto<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Get palette</span></span><br><span class="highlight-line">colors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Map pixel data into palette index, e.g. [0, 1, 0, 2, 1, 1, 0, 1, ...]</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span>colors<span class="token punctuation">.</span>index<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Group pixel data by 4, e.g. [(0, 1, 0, 2), (1, 1, 0, 1), ...]</span></span><br><span class="highlight-line">data <span class="token operator">=</span> groupinto<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Helper function for packing bits</span></span><br><span class="highlight-line">combine <span class="token operator">=</span> <span class="token keyword">lambda</span> l<span class="token punctuation">,</span> shift<span class="token punctuation">:</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span>y<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token operator">&lt;&lt;</span>shift<span class="token punctuation">)</span><span class="token operator">|</span>y<span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Combine 2 bit entries into an 1 byte, e.g. (0, 1, 0, 2) -> 0b10_00_01_00</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span>combine<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span></span></code></pre>
<p>And include it in the <code>.wat</code> file:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; brick texture 2bpp</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x400</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token string">"\aa\aa\aa\aa\aa\aa\aa\aa\00\00\00\00\02\00\00\00\ff\ff\ff\7f\f2\ff\ff\ff"</span></span><br><span class="highlight-line">  <span class="token string">"\ff\ff\ff\7f\f2\ff\ff\ff\fc\fc\fc\7c\f2\fc\fc\fc\f7\f7\f7\77\f2\f7\f7\f7"</span></span><br><span class="highlight-line">  <span class="token string">"\ff\ff\ff\7f\f2\ff\ff\ff\ff\ff\ff\7f\f2\ff\ff\ff\fc\fc\fc\7c\f2\fc\fc\fc"</span></span><br><span class="highlight-line">  <span class="token string">"\f7\f7\f7\77\f2\f7\f7\f7\ff\ff\ff\7f\f2\ff\ff\ff\ff\ff\ff\7f\f2\ff\ff\ff"</span></span><br><span class="highlight-line">  <span class="token string">"\fc\fc\fc\7c\f2\fc\fc\fc\f7\f7\f7\77\f2\f7\f7\f7\ff\ff\ff\7f\f2\ff\ff\ff"</span></span><br><span class="highlight-line">  <span class="token string">"\55\55\55\55\52\55\55\55\aa\aa\aa\aa\aa\aa\aa\aa\02\00\00\00\00\00\00\00"</span></span><br><span class="highlight-line">  <span class="token string">"\f2\ff\ff\ff\ff\ff\ff\7f\f2\ff\ff\ff\ff\ff\ff\7f\f2\fc\fc\fc\fc\fc\fc\7c"</span></span><br><span class="highlight-line">  <span class="token string">"\f2\f7\f7\f7\f7\f7\f7\77\f2\ff\ff\ff\ff\ff\ff\7f\f2\ff\ff\ff\ff\ff\ff\7f"</span></span><br><span class="highlight-line">  <span class="token string">"\f2\fc\fc\fc\fc\fc\fc\7c\f2\f7\f7\f7\f7\f7\f7\77\f2\ff\ff\ff\ff\ff\ff\7f"</span></span><br><span class="highlight-line">  <span class="token string">"\f2\ff\ff\ff\ff\ff\ff\7f\f2\fc\fc\fc\fc\fc\fc\7c\f2\f7\f7\f7\f7\f7\f7\77"</span></span><br><span class="highlight-line">  <span class="token string">"\f2\ff\ff\ff\ff\ff\ff\7f\52\55\55\55\55\55\55\55"</span></span><br><span class="highlight-line"><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; palette</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xd00</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; brick palette</span></span><br><span class="highlight-line">  <span class="token string">"\f3\5f\5f\ff\79\0e\0e\ff\00\00\00\ff\9f\25\25\ff"</span></span><br><span class="highlight-line"><span class="token punctuation">)</span></span></code></pre>
<p>Now we need to draw the wall with the correct texture. We can add a function
called <code>$texture</code> that samples our brick texture, given a uv coordinate. The
return value will be a 32-bit integer color.</p>
<p>The first thing we need to do is convert the uv coordinate (in the range \([0,
1)\)) to a pixel coordinate (in the range \([0, 32)\)). It's also convenient
if this function handles texture wrapping, so we can use it for texturing the
ceiling and floor too.</p>
<p>We can do all of this with the following equation:</p>
<p>$$
x = \lfloor 32(u - \lfloor u \rfloor) \rfloor
$$</p>
<p>Which can be written in wasm:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$frac-</span><span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$u</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32</span>.trunc_f32_s</span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>floor</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we can define a texture function that uses these coordinates:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$texture</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$u</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$v</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$x</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$y</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$x</span> <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$frac-</span><span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$frac-</span><span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  ...</span><br><span class="highlight-line"><span class="token punctuation">)</span></span></code></pre>
<p>To get the palette entry, we can't use the normal equation \(yw + x\), since
the pixels are packed 4 to a byte. Instead, we divide this index by 4, then
shift the byte down and mask to extract the bits we want:</p>
<p>$$
\text{entry} = (\text{load}(\lfloor\frac{yw + x}{4}\rfloor) \gg 2(x \bmod 4)) \land 3
$$</p>
<p>since the width is 32, we can simplify this:</p>
<p>$$
\begin{array}{lcl}
\text{entry} &amp;=&amp; (\text{load}(\lfloor\frac{32y + x}{4}\rfloor) \gg 2(x \bmod 4)) \land 3 \\
&amp;=&amp; (\text{load}(\lfloor\frac{32y}{4}\rfloor +\lfloor\frac{x}{4}\rfloor) \gg 2(x \bmod 4)) \land 3 \\
&amp;=&amp; (\text{load}(8y + \lfloor\frac{x}{4}\rfloor) \gg 2(x \bmod 4)) \land 3 \\
&amp;=&amp; (\text{load}((y \ll 3) + (x \gg 2)) \gg ((x \land 3) \ll 1)) \land 3
\end{array}
$$</p>
<p>Which can be converted to wasm (using the texture address of 0x400):</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shr_u</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x400</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">               <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shr_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Then we can read from this palette entry to get the RGBA color. The entry must
be left-shifted by 2 since it is 4 bytes per entry:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0xd00</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> &lt;palette entry> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we need to get the uv coordinates of the wall. The u coordinate is easy: it
is the <code>$t2</code> value we got from the intersection test. The v coordinate should
go from 0 at the top of the wall to 1 at the bottom. So we can convert from the
pixel location to a v coordinate with this equation, where <code>h</code> is actually the
half-height of the wall in pixels:</p>
<p>$$ v = \frac{y - (120 - h)}{2h} $$</p>
<p>So the new code for drawing a wall pixel is:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x3000</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$texture</span></span><br><span class="highlight-line">    <span class="token comment">;; u coordinate</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$mint2</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token comment">;; v coordinate</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>div</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32</span>.convert_i32_s</span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$height</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32</span>.convert_i32_s</span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$height</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Finally, we can try it out!</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-20-textured.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">1173 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-20-textured.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/3c32bf59856487b59a6620756c96ec7a">(.wat source)</a>
  </div>
</div>
<p>Did you notice that the texture is doubled up? We can add a single line to
<code>$frac-i32</code> to do this:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$frac-</span><span class="token keyword">i32</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$u</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$u</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  ...<span class="token punctuation">)</span></span></code></pre>
<p>This post is getting pretty long already! In the next one I'll add:</p>
<ul>
<li>Texturing the floor and ceiling</li>
<li>Shrinking the texture further with RLE compression</li>
<li>Randomly generating a maze</li>
<li>Handling collisions with walls</li>
<li>Making it into a real game (different modes)</li>
</ul>

  </div>
</article>

      </div>
    </main>

    <footer class="site-footer">
      <div class="wrapper">
        <div class="footer-wrapper">
          <ul class="footer">
            <li>
              by ben smith
            </li>
            <li>
              <a href="https://github.com/binji"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">binji</span></a>

              <a href="https://twitter.com/binjimint"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">binjimint</span></a>

            </li>
          </div>
        <div>
        <div class="footer-col-wrapper">
        </div>
      </div>
    </footer>
  </body>
</html>
