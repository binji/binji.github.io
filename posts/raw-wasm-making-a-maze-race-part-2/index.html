<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>raw wasm: making a maze race, part 2</title>
    <meta name="Description" content="">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/prism-ghcolors.css">

    <!-- copy-pasted favicon stuff from http://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

  </head>

  <body>
    <header class="site-header" role="banner">
      <div class="wrapper header-wrapper">
        <img class="site-binji-img" src="https://binji.github.io//assets/benji-banner-4x.png"></img>
        <a class="site-title" href="/">binji&#39;s dustbin</a>

        <nav class="site-nav">
          <div class="trigger">
            
              
              <a class="page-link" href="/about/">about</a>
              
            
          </div>
        </nav>
      </div>

    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">raw wasm: making a maze race, part 2</h1>
    
    <p class="post-meta"><time datetime="27 Oct 2020" itemprop="datePublished">27 Oct 2020</time></p>
    
  </header>

  <div class="post-content" itemprop="articleBody">
    <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_SVG">
</script>
<p>This post is part of a series. Read <a href="/posts/raw-wasm-making-a-maze-race/">part 1</a> first before reading this one!</p>
<h2>Step 5: Texturing the floor and ceiling</h2>
<p>When we finished last time, we were rendering four textured walls, with a solid
color for the ceiling and floor:</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-20-textured.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">1173 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-20-textured.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/3c32bf59856487b59a6620756c96ec7a">(.wat source)</a>
  </div>
</div>
<p>This is what Wolfenstein 3D did, but we can do better nowadays! The trick is to
realize that unlike a wall, which has a constant distance for each vertical
strip, the ceiling has a constant distance for each horizontal strip.</p>
<p>So we can create a nice texturing effect by using a distance table with an
entry for each y value on the screen. The closer the y-coordinate gets to the
center of the screen vertically, the further away the ceiling and floor must
be.</p>
<p>This demo shows how that distance table can be used. Lighter shades of gray are
used when the ceiling and floor are closer, and darker shades when they are
further away.</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-27-gradient.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn.
    </div>
  </div>
</div>
<p>We're using the following equation to calculate the half-height
(\(\mbox{hh}\)) of a wall in pixels, where \(t_1\) is the distance along
the ray to the intersection, and \(120\) is half of the screen height:</p>
<p>$$ \mbox{hh} = \left\lfloor \frac{120}{t_1} \right\rfloor $$</p>
<p>A wall is always drawn in the center of the screen.
So for any given vertical strip, the pixels filled are:</p>
<p>$$
\begin{array}{lcl}
\mbox{ceiling} &amp;=&amp; [0,120-\mbox{hh}) \\
\mbox{wall} &amp;=&amp; [120-\mbox{hh},120+\mbox{hh}) \\
\mbox{floor} &amp;=&amp; [120+\mbox{hh},240) \\
\end{array}
$$</p>
<p>This means that a wall that is 3 units away in world-space would be drawn with
a half-height of 40 pixels. This also means that the ceiling at \(y = 120 - 40
= 80\) is also 3 units away, since the ceiling starts at the same distance as
the top of the wall.</p>
<p>So we can calculate the distance of a given ceiling y-coordinate with the
equation:</p>
<p>$$ k = \frac{120}{120 - y} $$</p>
<p>We can create a table at the beginning of the program by using a <a href="https://webassembly.github.io/spec/core/syntax/modules.html#start-function">start
function</a>, which runs during WebAssembly instantation, before any exports can
be called. Creating a table saves us from having to do a divide per pixel:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">start</span> <span class="token variable">$init</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$init</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$y</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">loop</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token comment">;; mem[0xe00 + ($y &lt;&lt; 2)] = 120.0 / (120 - $y);</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0xe00</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>div</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32</span>.convert_i32_s <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">br_if</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>We can use this distance value when we're drawing the ceiling and floor to get
the uv coordinate to lookup into their textures. Since we store it from 0
through 120, top to bottom, we can start reading from the distance table in
order, and increment it once every time through the loop.</p>
<p>Since we draw the mirror floor pixel at the same time as the ceiling pixel, we
can use the same distance value for both.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dist-addr</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dist</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; Loop over all pixels in the ceiling and floor.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dist</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>load</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0xe00</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dist-addr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dist-addr</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dist-addr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  ...</span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">br_if</span> $<span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we need to figure out the uv coordinate of the pixel, given the distance.
Fortunately, that's not too hard! If we pretend that the wall has 0 height in
world-space (i.e. all rays are fired in a 2D plane), then the world position of
the intersection of the ray with the ceiling is:</p>
<p>$$ \textbf{c} = \textbf{o} + k\textbf{d} $$</p>
<p>Where \(\textbf{o}\) is the ray origin, and \(\textbf{d}\) is the direction
of the ray. In other words, it's \(k\) units in the direction of
the ray, starting at the player's position.</p>
<p><img src="/assets/2019-10-27-ray.png" alt="ray"></p>
<p>We can write this in wasm:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; find UV using distance table</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$u</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$Ox</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dx</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dist</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$v</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$Oy</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dy</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dist</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we can use this uv coordinate in our existing <code>$texture</code> function! But I
want to use a different texture for the floor and ceiling:</p>
<img src="/assets/2019-10-27-ceiling.png" width="256" height="256" style="image-rendering: pixelated;">
<p>We can converting this to 2 bits per pixel (bpp) the same way as last time, but
we need to modify the <code>$texture</code> function to allow different textures and
palettes first:</p>
<p>The <code>$tex-addr</code> and <code>$pal-addr</code> are added in right before doing the memory
load.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$texture</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$tex-addr</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$pal-addr</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$u</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$v</span> <span class="token keyword">f32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; Read palette entry.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$pal-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      ...</span><br><span class="highlight-line">        <span class="token comment">;; Read texture pixel.</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">            <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$tex-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">            ...</span><br><span class="highlight-line">            <span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we can update where we draw the ceiling and floor pixels to do a texture
lookup instead:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; draw ceiling</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x3000</span>  <span class="token comment">;; RGBA pixel address</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$texture</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x500</span><span class="token punctuation">)</span>  <span class="token comment">;; texture address</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xd10</span><span class="token punctuation">)</span>  <span class="token comment">;; palette address</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">...</span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; draw floor</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x3000</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$bot-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$texture</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x500</span><span class="token punctuation">)</span>  <span class="token comment">;; texture address</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xd1c</span><span class="token punctuation">)</span>  <span class="token comment">;; palette address</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$u</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>We can use the same texture with a different palette for the ceiling to make it
a bit more visually interesting, for only 16 bytes!</p>
<p>Ceiling palette:</p>
<img src="/assets/2019-10-27-ceiling-palette.png" width="192" height="64" style="image-rendering: pixelated;">
<p>Floor palette:</p>
<img src="/assets/2019-10-27-floor-palette.png" width="192" height="64" style="image-rendering: pixelated;">
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0xd00</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; brick palette</span></span><br><span class="highlight-line">  <span class="token string">"\f3\5f\5f\ff\79\0e\0e\ff\00\00\00\ff\9f\25\25\ff"</span></span><br><span class="highlight-line">  <span class="token comment">;; ceiling palette</span></span><br><span class="highlight-line">  <span class="token string">"\62\8d\c6\ff\81\95\af\ff\62\8d\c6\ff"</span></span><br><span class="highlight-line">  <span class="token comment">;; floor palette</span></span><br><span class="highlight-line">  <span class="token string">"\81\95\af\ff\b5\b5\b5\ff\62\8d\c6\ff"</span></span><br><span class="highlight-line"><span class="token punctuation">)</span></span></code></pre>
<p>Let's see it in action:</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-27-ceiling-and-floor.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">1555 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-27-ceiling-and-floor.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/53ee5326803242d3b8bda0840f6f9b57">(.wat source)</a>
  </div>
</div>
<h2>Step 6: Making a maze</h2>
<p>It's pretty fun to run around already, but this is supposed to be a maze race,
not a big square room race. I started to think the demo looked kind of like the
Windows 98 maze screensaver, just without a maze.</p>
<p>At this point, I thought I might try to recreate the look of that screensaver,
so I tried looking for some info about it. I found a great twitter thread by
<a href="https://twitter.com/foone">Foone Turing</a> discussing the maze generation algorithm the screensaver
used (as well as a lot of other interesting stuff):</p>
<div class="twitter">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Three fun facts about the Windows 9x &quot;3D Maze&quot; screen saver:<br>1. The source to it is in the NT 4.0 SDK<br>2. You can set the number of rats. It&#39;s normally at 1, but it can go as high as 10. <br>3. It&#39;s biased towards lefties. <a href="https://t.co/QlAbhXwH8T">pic.twitter.com/QlAbhXwH8T</a></p>&mdash; foone (@Foone) <a href="https://twitter.com/Foone/status/1018649977608798208?ref_src=twsrc%5Etfw">July 16, 2018</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>In particular:</p>
<blockquote>
<p>I also did some research on how it generates the maze. It uses Kruskal's
algorithm. At the start, the maze is full of walls, and consists of 144
separate sets. It randomly selects a wall, and if each side of the wall is in
a separate set, it deletes the wall and merges the sets</p>
</blockquote>
<blockquote>
<p>this repeats until there's only one set left. Now every cell in the maze is
connected to every other cell in the maze by one unique path.</p>
</blockquote>
<p>Foone also mentions that this algorithm can be found in <a href="https://twitter.com/jamis">Jamis Buck</a>'s
book, <a href="http://www.mazesforprogrammers.com/">Mazes for Programmers</a>. But it's also in a <a href="http://weblog.jamisbuck.org/2011/1/3/maze-generation-kruskal-s-algorithm">blog post</a> by Jamis too! This is a really great blog post, with nice pictures,
interactive demos, and Ruby code implementing the algorithm. Give it a read!</p>
<p>To implement the algorithm, we need to decide how big the maze is. I chose a 12
by 12 maze, since that was what the Windows 98 screensaver did. This means that
there are 144 cells in the grid. At the start of the algorithm no cells are
connected, so there are also 144 distinct cell sets.</p>
<p>We start with every possible wall in the grid filled in. The boundaries of the
maze are always included, so the algorithm only needs to consider the interior
walls. For an \(n\) by \(m\) maze, we start with \(m(n - 1)\) vertical
walls and \(n(m - 1)\) horizontal walls. For a 12 by 12 maze, that gives 264
initial walls.</p>
<p>Every step, we choose a wall whose two sides are not already in the same cell
set and remove that wall. This means that after every step we have reduced the
number of cell sets by 1. Since we start with \(nm\) cell sets and we end
when there is a single cell set, the algorithm must run for \(nm - 1\) steps.
We know we have \(m(n - 1) + n(m - 1) = 2nm - m - n\) initial walls and we
remove a wall every step, the final number of walls is always:</p>
<p>$$
(2nm - m - n) - (nm - 1) \\
nm - m - n + 1 \\
(n - 1)(m - 1)
$$</p>
<p>or in our case, 121 walls.</p>
<p>Now that we know the maximum number of cells and walls, we can start to do the
data design for the algorithm. Each grid cell needs to store a number which
identifies which cell set it belongs to. Since there are a maximum of 144 cell
sets, we can use a byte to represent this number, which we'll call a cell set
ID.</p>
<p>The WebAssembly text format doesn't let you allocate memory or even name memory
addresses, so I just keep a little comment near the top of the file laying out
where everything is. So here's the layout for this 12 by 12 cell set grid. For
now, I use 256 bytes of space, even though I only need 144.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; [0x0000, 0x0100)   u8[12*12]       maze cells for Kruskal's algo</span></span></code></pre>
<p>Next we need an array of walls. Each wall is defined by which two grid cells it
connects. Each grid cell can be given a number from 0 to 143, counting from the
upper-left corner, moving right across columns, then down over rows. For
example, cell 0 is the upper-left corner, cell 11 is the upper-right corner,
and cell 143 is the lower-right corner of the grid. So each wall contains two
cell IDs (not to be confused with the cell set IDs).</p>
<p>Each wall is either horizontal or vertical. Vertical walls divide two adjacent
cells in the same row, which means their cell IDs always differ by 1.
Horizontal walls divide two adjacent cells in the same column, so their cell
IDs always differ by 12. Therefore we don't actually need to store the
direction of the wall in our wall &quot;struct&quot;, since we can always recover this
information from the two cell IDs.</p>
<p>Here's the data layout for the wall array:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; Cell2: u8*2      ; left/up cell, right/down cell</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; [0x0100, 0x0310)   Cell2[12*11*2]  walls for Kruskal's algo</span></span></code></pre>
<p>Now to the code! Here are the steps:</p>
<ol>
<li>Initialize the cell set array</li>
<li>Initialize the wall array</li>
<li>While the number of walls is not 121:
<ol>
<li>Pick a random wall from the wall array</li>
<li>Get the cell IDs for this wall</li>
<li>Look up the cell set IDs, <code>c1</code> and <code>c2</code>, for each cell ID</li>
<li>If the cell set IDs are not equal:
<ol>
<li>Remove this wall</li>
<li>Loop over all cell set IDs in the grid, and replace <code>c2</code> by <code>c1</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>You can see how it works in this interactive demo:</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="420" height="480" scrolling="no" src="/assets/2019-10-27-mazegen.html"></iframe>
    <div class="info" style="max-width: 420px">
      Use the &lt; or &gt; buttons to step through the algorithm, or scrub back
      and forth with the slider.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-27-mazegen.html">(source)</a>
  </div>
</div>
<p>First we initialize the cell set array. We could do this with a single loop
instead of two loops, but this way we can initialize the wall array in the same
loop:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$x</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$y</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$y-</span><span class="token keyword">loop</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$x</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$x-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token comment">;; Each cell is "owned" by itself at the start.</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token comment">;; increment cell index.</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$i</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$x-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$x</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$y-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$y</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we'll initialize the wall array. Outside the loop, we need to add a new
variable <code>$wall-addr</code>, which tracks which wall we should add next:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$wall-addr</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$wall-addr</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Inside the loop, we add a vertical wall whenever the x coordinate is less than
11, and a horizontal wall whenever the y coordinate is less than 11.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line">  <span class="token comment">;; Add vertical wall, connecting cell i and i + 1.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">      <span class="token comment">;; mem[$wall-addr] = $i;</span></span><br><span class="highlight-line">      <span class="token comment">;; mem[$wall-addr + 1] = $i + 1;</span></span><br><span class="highlight-line">      <span class="token comment">;; $wall-addr += 2;</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">1</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$wall-addr</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; add horizontal wall, connecting cell i and i + 12.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$y</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">      <span class="token comment">;; mem[$wall-addr] = $i;</span></span><br><span class="highlight-line">      <span class="token comment">;; mem[$wall-addr] = $i + 12;</span></span><br><span class="highlight-line">      <span class="token comment">;; $wall-addr += 2;</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">1</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$wall-addr</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>The next step is to randomly choose and remove walls, until there are 121
walls. The main loop looks like this:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$walls</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">264</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">;; 12 * 11 * 2</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$wall-</span><span class="token keyword">loop</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; loop until there are exactly 11 * 11 walls.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$wall-</span><span class="token keyword">loop</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>gt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$walls</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>WebAssembly doesn't have a way to generate randomness, but we can import
<code>Math.random</code> from JavaScript:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"Math"</span> <span class="token string">"random"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$random</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p><code>Math.random</code> returns a random number in the range \([0,1)\), so we can pick
a random wall by multiplying this value by the number of walls and truncating
the result:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; 0x100 is the base address of the array.</span></span><br><span class="highlight-line"><span class="token comment">;; Shift left by 1 since the wall size is 1.</span></span><br><span class="highlight-line"><span class="token comment">;;</span></span><br><span class="highlight-line"><span class="token comment">;; $wall-addr = 0x100 + ((random() * $walls) &lt;&lt; 1);</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$wall-addr</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x100</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32</span>.trunc_f32_s</span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">f32<span class="token punctuation">.</span>mul</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">call</span> <span class="token variable">$random</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">f32</span>.convert_i32_s <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$walls</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now we read the cell set IDs, <code>$c1</code> and <code>$c2</code>:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$c1</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$c2</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>If the IDs are not equal, then we remove this wall. We can use the classic
array removal trick where we copy the last element over the one we want to
remove:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>ne</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$c1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$c2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">    <span class="token comment">;; Remove this wall by copying the last wall over it.</span></span><br><span class="highlight-line">    <span class="token comment">;; mem[$wall-addr] = mem[0x100 + (--$walls &lt;&lt; 1)];</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$walls</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$walls</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store16</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$wall-addr</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load16_u</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">0x100</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$walls</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    ...</span></code></pre>
<p>then we replace <code>$c2</code> with <code>$c1</code> everywhere in the grid:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$i</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$remove-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">  <span class="token comment">;; if (mem[$i] == $c2) mem[$i] = $c1;</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>eq</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$c2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$c1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$remove-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$i</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">144</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Finally we have to use this list of walls to build up the real list of walls
that we want to use in-game. Each wall has two points. We can recover the x and
y coordinate of those points from the cell ID with:</p>
<p>$$
x = \mbox{id} \bmod 12 \\
y = \frac{\mbox{id}}{12}
$$</p>
<p>The code isn't very interesting, so I'll omit it here. You can look at the
<a href="https://github.com/binji/raw-wasm/blob/0322d4594a1d4348dbabe651af3d114444bb5c4f/maze/maze.wat#L201">source</a> if you're curious.</p>
<p>Let's see what our maze looks like!</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-27-maze.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">1955 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-27-maze.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/964eb4d7c0d7ee09b6de25e3ac2f88d6">(.wat source)</a>
  </div>
</div>
<p>Not bad for 411 extra bytes of code  (we'll shrink this down later.)</p>
<h2>Step 7: Compressing Textures</h2>
<p>Right now our textures are taking up 512 bytes, since each one is 32x32 pixels
and 2 bpp. This is pretty good, but we could do better! One way would be to
store the textures compressed, then decompress them at initialization time.</p>
<p>The hard part is making sure that we're actually saving space! Currently we are
spending 512 bytes on textures, and 0 bytes on a decompressor. If we compress
the textures to 256 bytes but need 300 bytes of code to decompress it, we've
failed. </p>
<p>On the other hand, since we're not making a general-purpose compressor, we can
tweak it as much as we want for our data until it compresses well.</p>
<p>In any case, we'll need to make sure that our compression scheme is both pretty
good, but also pretty simple. I usually go for <a href="https://en.wikipedia.org/wiki/Run-length_encoding">run-length encoding</a>
(RLE).</p>
<p>The basic idea is to encode &quot;runs&quot; of values as a pair of values: a count and a
value. For example, we can encode the string &quot;AAABBBXYZAAAAAAAAABBB&quot; as
&quot;3A3B1X1Y1Z9A3B&quot;.</p>
<p>This works well, but if our data has many singletons in a row (i.e. runs of 1),
then this will be bigger than the original data (e.g. &quot;XYZ&quot; becomes &quot;1X1Y1Z&quot;).
One trick to work around this is to encode a singleton run by using a negative
count. This is still larger than the original string, but it's a little better.</p>
<p>We're not encoding strings, of course, but bytes. So our decoding will be as
follows, where \(n\) and \(x\) are bytes, and \(x^n\) means a run of
\(n\) \(x\)'s.</p>
<p>$$
\begin{array}{lcll}
n~x &amp;\Rightarrow&amp; x^n &amp;(\mathrel{\mbox{if} } n &gt;= 0) \\
n~x_1~x_2~...~x_{-n} &amp;\Rightarrow&amp; x_1~x_2~...~x_{-n} &amp;(\mathrel{\mbox{otherwise} }) \\
\end{array}
$$</p>
<p>This is a little silly, since the \(n=0\) case isn't useful, but the
decompression code ends up simpler.</p>
<p>Here's a technique we can use to compress this. It's not how I originally wrote
it, but I think it's nicer this way.</p>
<p>First, we can use <code>itertools</code>'s <a href="https://docs.python.org/3/library/itertools.html#itertools.groupby">groupby</a> function to produce runs, along
with their length. Because <code>v</code> is an iterator, it must be converted to a list
before we can extract the length:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># Step 1: Group runs</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> groupby<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">]</span></span></code></pre>
<p>We can use <code>groupby</code> a second time to group all singleton and non-singleton
runs:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># Step 2: Group singleton and non-singleton runs</span></span><br><span class="highlight-line">is_singleton <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token keyword">for</span> _<span class="token punctuation">,</span> v <span class="token keyword">in</span> groupby<span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token operator">=</span>is_singleton<span class="token punctuation">)</span><span class="token punctuation">]</span></span></code></pre>
<p>Now we use a helper function to combine singleton runs, and flatten
non-singleton runs. Note the <code>256-len(v)</code> part: this converts the length to a
negative signed 8-bit integer in two's complement format:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># Step 3: Combine singleton runs, flatten others</span></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">combine_singletons</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> is_singleton<span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token operator">-</span><span class="token builtin">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> v<span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token keyword">else</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> t <span class="token keyword">in</span> v <span class="token keyword">for</span> x <span class="token keyword">in</span> t<span class="token punctuation">]</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span>combine_singletons<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span></span></code></pre>
<p>And finally we flatten the list of lists:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># Step 4: Flatten all lists</span></span><br><span class="highlight-line">data <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> l <span class="token keyword">in</span> data <span class="token keyword">for</span> x <span class="token keyword">in</span> l<span class="token punctuation">]</span></span></code></pre>
<p>Try playing with this demo to see how it works:</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="420" height="450" src="/assets/2019-10-27-rle-demo.html"></iframe>
    <div class="info" style="max-width: 420px;">
      Use the &lt; or &gt; buttons to step through the algorithm, or scrub back
      and forth with the slider.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-27-rle-demo.html">(source)</a>
  </div>
</div>
<p>I made the brick texture less noisy, compressed the textures, and ended up with
a total of 256 bytes for both!</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x400</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; brick texture 2bpp RLE compressed</span></span><br><span class="highlight-line">  <span class="token string">"\08\aa\04\00\ff\02\03\00\03\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06"</span></span><br><span class="highlight-line">  <span class="token string">"\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52"</span></span><br><span class="highlight-line">  <span class="token string">"\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5"</span></span><br><span class="highlight-line">  <span class="token string">"\52\03\55\04\ff\ff\f2\03\ff\08\aa\ff\02\07\00\ff\52\06\55\fe\d5\52\06\55"</span></span><br><span class="highlight-line">  <span class="token string">"\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06"</span></span><br><span class="highlight-line">  <span class="token string">"\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52\06\55\fe\d5\52"</span></span><br><span class="highlight-line">  <span class="token string">"\06\55\fe\d5\52\06\55\fe\d5\f2\07\ff"</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; floor and ceiling texture 2bpp RLE compressed</span></span><br><span class="highlight-line">  <span class="token string">"\fe\00\56\05\55\fd\02\80\56\05\55\fe\0a\a0\06\55\fe\29\68\06\55\fe\a5\5a"</span></span><br><span class="highlight-line">  <span class="token string">"\06\55\ff\95\3b\55\fe\95\5a\06\55\fe\a5\68\06\55\fe\29\a0\06\55\fd\0a\80"</span></span><br><span class="highlight-line">  <span class="token string">"\56\05\55\fd\02\00\56\05\55\fd\0a\80\56\05\55\fe\29\a0\06\55\fe\a5\68\06"</span></span><br><span class="highlight-line">  <span class="token string">"\55\fe\95\5a\3b\55\ff\5a\06\55\fe\95\68\06\55\fe\a5\a0\06\55\fd\29\80\56"</span></span><br><span class="highlight-line">  <span class="token string">"\05\55\ff\0a"</span></span><br><span class="highlight-line"><span class="token punctuation">)</span></span></code></pre>
<p>For the decompressor function, we'll loop over all bytes of the source, and
write to a destination address <code>0x500</code>.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$decompress-textures</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$src</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$dst</span> <span class="token keyword">i32</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x400</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dst</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$src-</span><span class="token keyword">loop</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    ...</span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$src-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>lt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0x500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>For each byte of the source, we read the run count. If the number is negative,
then we read <code>-count</code> bytes from the source into the destination. If the
number is positive, then we read one value and duplicate it for <code>count</code> bytes.</p>
<p>We can handle both of these cases in the same code by using a <code>$d-src</code>
variable: how much to increment <code>$src</code> after each step of the run. For a
singleton run, <code>$d-src</code> is 1, and for a normal run <code>$d-src</code> is 0.</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; Load signed 8-bit count from $src.</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$count</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>gt_s</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$count</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">then</span></span><br><span class="highlight-line">    <span class="token comment">;; Run of length $count.</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$d-src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">else</span></span><br><span class="highlight-line">    <span class="token comment">;; -$count singleton elements.</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$count</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$count</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$d-src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>For each byte in the run, we update the source pointer, and read the source
byte:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">loop</span> <span class="token variable">$dst-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$src</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$d-src</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$byte</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>load8_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$src</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">br_if</span> <span class="token variable">$dst-</span><span class="token keyword">loop</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">local</span>.tee <span class="token variable">$count</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>sub</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$count</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>Now that we're processing our textures at runtime, we can simplify our texture
lookup. Instead of using 2bpp lookup in the <code>$texture</code> function, we can
decompress into 8bpp textures. The final shift left by 2 is equivalent to
multiplying by 4, to account for the 32-bit RGBA palette entries:</p>
<pre class="language-wasm"><code class="language-wasm"><span class="highlight-line"><span class="token comment">;; mem[$dst] = ($byte &amp; 3) &lt;&lt; 2;</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dst</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; mem[$dst+1] = (($byte >> 2) &amp; 3) &lt;&lt; 2;</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store8</span> <span class="token keyword">offset<span class="token operator">=</span></span><span class="token number">1</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dst</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shl</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>and</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>shr_u</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">... <span class="token comment">;; Similar for for other two bytes.</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">;; $dst += 4;</span></span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">local</span>.set <span class="token variable">$dst</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$dst</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>So how did we do? Well, the final binary is now 1833 bytes, for a savings of
122 bytes. Not bad! (We'll improve this later too).</p>
<div class="wasm-demo">
  <div class="iframe-wrapper">
    <iframe width="400" height="300" src="/assets/2019-10-27-rle.html"></iframe>
    <div class="info" style="max-width: 400px;">
      Use the arrow keys to move, or tap on the left or right side of the screen to turn. <span class="size">1833 bytes</span>.
    </div>
    <a href="https://github.com/binji/binji.github.io/blob/master/assets/2019-10-27-rle.html">(HTML source)</a>
    <a href="https://gist.github.com/binji/729472b4a25520b39e65c96d8e300967">(.wat source)</a>
  </div>
</div>
<p>In the next post (or maybe after), we'll cover:</p>
<ul>
<li>Handling collisions with walls</li>
<li>Making it into a real game</li>
<li>Shrinking the whole thing back to 2047 bytes!</li>
</ul>

  </div>
</article>

      </div>
    </main>

    <footer class="site-footer">
      <div class="wrapper">
        <div class="footer-wrapper">
          <ul class="footer">
            <li>
              by ben smith
            </li>
            <li>
              <a href="https://github.com/binji"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">binji</span></a>

              <a href="https://twitter.com/binjimint"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">binjimint</span></a>

            </li>
          </div>
        <div>
        <div class="footer-col-wrapper">
        </div>
      </div>
    </footer>
  </body>
</html>
