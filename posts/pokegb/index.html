<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POKEGB: a gameboy emulator that only plays Pokémon blue</title>
    <meta name="Description" content="">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/prism-ghcolors.css">

    <!-- copy-pasted favicon stuff from http://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

  </head>

  <body>
    <header class="site-header" role="banner">
      <div class="wrapper header-wrapper">
        <img class="site-binji-img" src="https://binji.github.io//assets/benji-banner-4x.png"></img>
        <a class="site-title" href="/">binji&#39;s dustbin</a>

        <nav class="site-nav">
          <div class="trigger">
            
              
              <a class="page-link" href="/about/">about</a>
              
            
          </div>
        </nav>
      </div>

    </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">POKEGB: a gameboy emulator that only plays Pokémon blue</h1>
    
    <p class="post-meta"><time datetime="03 Jun 2021" itemprop="datePublished">03 Jun 2021</time></p>
    
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1>POKEGB: A gameboy emulator that only plays Pokémon Blue</h1>
<p>I recently tweeted out an emulator that I made over the last few days:</p>
<div class="twitter">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">POKEGB: A gameboy emulator that only plays Pokémon Blue, in 62 lines of c++.<br>source: <a href="https://t.co/AGt7RUTr9H">https://t.co/AGt7RUTr9H</a> <a href="https://t.co/o0BUUmzNOt">pic.twitter.com/o0BUUmzNOt</a></p>&mdash; Ben Smith (@binjimint) <a href="https://twitter.com/binjimint/status/1398311179164872704?ref_src=twsrc%5Etfw">May 28, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>In the video, I show some source code that looks like 3 pokéballs, compile it
with gcc, and run it to play Pokémon Blue. The game is controllable, but has no
sound. It renders the graphics w/ 12 colors (shades of red and blue). I choose
BLUE as the name for our hero, and JERK as the name of his rival. The video
ends when Professor Oak stops me from walking into the tall grass.</p>
<p>A lot of folks asked me to do a write-up of how this all works, so let's dive in!</p>
<p>(<strong>TL;DR</strong>: this is a very long writeup, check out the <a href="https://gist.github.com/binji/395669d45e9005950232043ab4378abe">unobfuscated
code</a> instead if you prefer!)</p>
<p><img src="/assets/2021-06-03-pokegb.gif" alt="intro-gif"></p>
<h2>Stats</h2>
<p>But first, let's talk a little about some statistics. The final version in that
tweet is actually 68 lines of code (I tweeted the wrong number!), each line
less than 150 characters long, for a total of 9956 bytes. If you ignore
whitespace and comments, it comes to 4720 bytes. That's too large for the
<a href="https://www.ioccc.org/">International Obfuscated C Code Contest</a>, but pretty close.</p>
<p>Prior to formatting the source code to look like pokéballs, the source was 188
lines and a total of 7786 bytes, with 5954 bytes of non-whitespace source.</p>
<h2>Overview</h2>
<p>It'll be useful to know a little about how the gameboy works. This won't go
into all the details (for that you can <a href="https://gbdev.io/pandocs">read the pandocs</a> or perhaps watch <a href="https://youtu.be/HyzD8pNlpwI">The Ultimate Gameboy Talk</a>), but will
be enough to understand how this code works. Many values are easier to
represent in hexadecimal, so I'll write those with a leading <code>$</code>, e.g. <code>$FE00</code>.</p>
<p><img src="/assets/2021-06-03-pokegb2.gif" alt="pokeprof-gif"></p>
<h3>CPU</h3>
<p>The gameboy CPU is a bit weird — it's kind of like an <a href="https://en.wikipedia.org/wiki/Intel_8080">Intel 8080</a>
and kind of like a <a href="https://en.wikipedia.org/wiki/Zilog_Z80">Zilog Z80</a>, but not the same as either. It has an
8-bit accumulator <code>A</code>, and three 16-bit register pairs, <code>BC</code>, <code>DE</code>, and <code>HL</code>,
which can be individually accessed as the 8-bit registers <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code>,
<code>H</code> and <code>L</code>. It also has a 16-bit stack pointer <code>SP</code>, a 16-bit program counter
<code>PC</code>.</p>
<table>
<thead>
<tr>
<th>16-bit</th>
<th>High byte</th>
<th>Low byte</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AF</td>
<td>A</td>
<td>-</td>
<td>Accumulator and flags</td>
</tr>
<tr>
<td>BC</td>
<td>B</td>
<td>C</td>
<td>General purpose</td>
</tr>
<tr>
<td>DE</td>
<td>D</td>
<td>E</td>
<td>General purpose</td>
</tr>
<tr>
<td>HL</td>
<td>H</td>
<td>L</td>
<td>General purpose / memory access</td>
</tr>
<tr>
<td>PC</td>
<td>-</td>
<td>-</td>
<td>Program counter</td>
</tr>
<tr>
<td>SP</td>
<td>-</td>
<td>-</td>
<td>Stack pointer</td>
</tr>
</tbody>
</table>
<p>The cpu also has 4 flag bits: <code>Z</code>, <code>N</code>, <code>H</code>, and <code>C</code>:</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Z</td>
<td>Zero flag</td>
<td>Set when the result is zero</td>
</tr>
<tr>
<td>N</td>
<td>Subtraction flag</td>
<td>Set if the last instruction was subtract, used for BCD</td>
</tr>
<tr>
<td>H</td>
<td>Half-carry flag</td>
<td>Set if there is an overflow out of bit 3, used for BCD</td>
</tr>
<tr>
<td>C</td>
<td>Carry flag</td>
<td>Set if there is an overflow out of bit 7</td>
</tr>
</tbody>
</table>
<p>When accessing the AF register (which can only be done via push/pop
instructions), the flags are stored in the most-significant bits of F:</p>
<table>
<thead>
<tr>
<th>15</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>A</td>
<td>A</td>
<td>A</td>
<td>A</td>
<td>A</td>
<td>A</td>
<td>A</td>
<td>Z</td>
<td>N</td>
<td>H</td>
<td>C</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>The gameboy instruction set has ~500 instructions, each up to 3 bytes long. For
example, the <code>NOP</code> instruction is just one byte (<code>00</code>), but the <code>JP</code>
instruction is 3 bytes: <code>$C3</code> followed by a 16-bit address <code>$50 $01</code>.</p>
<p>The instructions can be grouped as follows (taken from <a href="https://cdn.discordapp.com/attachments/465586075830845475/742438340078469150/SM83_decoding.pdf">peach.bot's excellent
document</a> on the <a href="https://discord.com/invite/AcqzxjpX">Emulation Development discord</a>). I've included all instructions, but have struck through the ones
that are not needed for Pokémon Blue. Feel free to skip over this on first
read, I'll go into more detail later:</p>
<table>
<thead>
<tr>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
<th>Mnemonic</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>NOP</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td><s>LD (u16), SP</s></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td><s>STOP</s></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>JR</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1 <td colspan=2 class="td-colspan"> condition</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>JR condition</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 1)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>LD r16, u16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 2)</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>LD (r16), A</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 1)</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>INC r16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 1)</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>ADD HL, r16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 2)</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>LD A, (r16)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=2 class="td-colspan"> r16 (group 1)</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>DEC r16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=3 class="td-colspan"> r8</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>INC r8</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=3 class="td-colspan"> r8</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>DEC r8</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=3 class="td-colspan"> r8</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>LD r8, u8</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0 <td colspan=3 class="td-colspan"> opcode (group 1)</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Opcode Group 1</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>HALT</td>
</tr>
<tr>
<td>0</td>
<td>1 <td colspan=3 class="td-colspan"> r8 (destination) <td colspan=3 class="td-colspan"> r8 (source)</td>
<td>LD r8, r8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>0 <td colspan=3 class="td-colspan"> opcode (group 2) <td colspan=3 class="td-colspan"> r8 (operand 2)</td>
<td>ALU A, r8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0 <td colspan=2 class="td-colspan"> condition</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>RET condition</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0 <td colspan=2 class="td-colspan"> condition</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>JP condition</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0 <td colspan=2 class="td-colspan"> condition</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>CALL condition</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>CALL u16</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>LD ($FF00 + u8), A</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>LD ($FF00 + C), A</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td><s>ADD SP, i8</s></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>LD (u16), A</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>LD A, ($FF00 + u8)</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td><s>LD A, ($FF00 + C)</s></td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>LD HL, SP + i8</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>LD A, (u16)</td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=2 class="td-colspan"> r16 (group 3)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>POP r16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=3 class="td-colspan"> opcode (group 4)</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>Opcode group 4</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=2 class="td-colspan"> r16 (group 3)</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>PUSH r16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=3 class="td-colspan"> opcode (group 2)</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>ALU A, u8</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=3 class="td-colspan"> EXP</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td><s>RST (call to 00EXP000)</s></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>You can also use the <code>CB</code> prefix to access a different set of instructions:</p>
<table>
<thead>
<tr>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
<th>Mnemonic</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0 <td colspan=3 class="td-colspan"> opcode (group 3) <td colspan=3 class="td-colspan"> r8</td>
<td>Shift/Rotate</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1 <td colspan=3 class="td-colspan"> bit <td colspan=3 class="td-colspan"> r8 (source)</td>
<td>BIT bit, r8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>0 <td colspan=3 class="td-colspan"> bit <td colspan=3 class="td-colspan"> r8 (source/dest)</td>
<td>RES bit, r8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1 <td colspan=3 class="td-colspan"> bit <td colspan=3 class="td-colspan"> r8 (source/dest)</td>
<td>SET bit, r8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><code>r8</code> is encoded as:</p>
<table>
<thead>
<tr>
<th>value</th>
<th>register</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>B</td>
</tr>
<tr>
<td>1</td>
<td>C</td>
</tr>
<tr>
<td>2</td>
<td>D</td>
</tr>
<tr>
<td>3</td>
<td>E</td>
</tr>
<tr>
<td>4</td>
<td>H</td>
</tr>
<tr>
<td>5</td>
<td>L</td>
</tr>
<tr>
<td>6</td>
<td>(HL)</td>
</tr>
<tr>
<td>7</td>
<td>A</td>
</tr>
</tbody>
</table>
<p><code>r16</code> is encoded as:</p>
<table>
<thead>
<tr>
<th>value</th>
<th>group 1</th>
<th>group 2</th>
<th>group 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>BC</td>
<td>BC</td>
<td>BC</td>
</tr>
<tr>
<td>1</td>
<td>DE</td>
<td>DE</td>
<td>DE</td>
</tr>
<tr>
<td>2</td>
<td>HL</td>
<td>HL+</td>
<td>HL</td>
</tr>
<tr>
<td>3</td>
<td>SP</td>
<td>HL-</td>
<td>AF</td>
</tr>
</tbody>
</table>
<p><code>condition</code> is encoded as:</p>
<table>
<thead>
<tr>
<th>value</th>
<th>condition</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>NZ</td>
<td>Zero flag is 0</td>
</tr>
<tr>
<td>1</td>
<td>Z</td>
<td>Zero flag is 1</td>
</tr>
<tr>
<td>2</td>
<td>NC</td>
<td>Carry flag is 0</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
<td>Carry flag is 1</td>
</tr>
</tbody>
</table>
<p><code>opcode</code> is encoded as:</p>
<table>
<thead>
<tr>
<th>value</th>
<th>group 1</th>
<th>group 2</th>
<th>group 3</th>
<th>group 4</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>RLCA</td>
<td>ADD</td>
<td>RLC</td>
<td>JP</td>
</tr>
<tr>
<td>1</td>
<td>RRCA</td>
<td>ADC</td>
<td>RRC</td>
<td>CB prefix</td>
</tr>
<tr>
<td>2</td>
<td>RLA</td>
<td>SUB</td>
<td>RL</td>
<td>illegal</td>
</tr>
<tr>
<td>3</td>
<td><s>RRA</s></td>
<td>SBC</td>
<td>RR</td>
<td>illegal</td>
</tr>
<tr>
<td>4</td>
<td>DAA</td>
<td>AND</td>
<td>SLA</td>
<td>illegal</td>
</tr>
<tr>
<td>5</td>
<td>CPL</td>
<td>XOR</td>
<td>SRA</td>
<td>illegal</td>
</tr>
<tr>
<td>6</td>
<td>SCF</td>
<td>OR</td>
<td>SWAP</td>
<td>DI</td>
</tr>
<tr>
<td>7</td>
<td>CCF</td>
<td>CP</td>
<td>SRL</td>
<td>EI</td>
</tr>
</tbody>
</table>
<p>As you can see, there are many instructions but we can group them into ~40
different categories, 5 of which aren't used by Pokémon Blue (as far as I
know). (Turns out I was wrong, <code>RRA</code> is used; see the <a href="https://github.com/pret/pokered/blob/2954013da1f10e11db4ec96f9586b7c01706ae1a/engine/pokemon/learn_move.asm#L109">TryingToLearn function
in the pokered source</a>).</p>
<p>One additional complication is how long each of these instructions take to
execute. This is measured in &quot;T-states&quot;, which run at the frequency of the CPU,
~4.19MHz. All instructions operate on a multiple of 4 T-states, which is often
called machine-cycles or &quot;M-cycles&quot;.</p>
<p>It's important to keep track of how many M-cycles each instruction takes, since
other hardware components (such as the graphics rendering and audio) take time
too, and we want to make sure that the CPU and these components stay in sync.
Fortunately, the M-cycle counts for most instructions is relatively simple
— every memory access costs 1 M-cycle (including the cost of reading the
instruction). Some instructions take additional M-cycles, but we can handle
those cases explicitly.</p>
<h3>Memory</h3>
<p>The gameboy CPU has a 16-bit address space, divided up into regions with
different purposes. Here's a simplified layout:</p>
<table>
<thead>
<tr>
<th>Low</th>
<th>High</th>
<th>Size (in bytes)</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>$0000</td>
<td>$3FFF</td>
<td>16384</td>
<td>Cartridge ROM bank 0</td>
</tr>
<tr>
<td>$4000</td>
<td>$7FFF</td>
<td>16384</td>
<td>Cartridge ROM bank 1</td>
</tr>
<tr>
<td>$8000</td>
<td>$9FFF</td>
<td>8192</td>
<td>Video RAM</td>
</tr>
<tr>
<td>$A000</td>
<td>$BFFF</td>
<td>8192</td>
<td>External RAM (often battery-backed)</td>
</tr>
<tr>
<td>$C000</td>
<td>$DFFF</td>
<td>8192</td>
<td>Work RAM</td>
</tr>
<tr>
<td>$E000</td>
<td>$FDFF</td>
<td>7680</td>
<td>Mirror of C000-DEFF</td>
</tr>
<tr>
<td>$FE00</td>
<td>$FE9F</td>
<td>160</td>
<td>Object attribute memory (OAM)</td>
</tr>
<tr>
<td>$FEA0</td>
<td>$FEFF</td>
<td>96</td>
<td>Unused</td>
</tr>
<tr>
<td>$FF00</td>
<td>$FF7F</td>
<td>128</td>
<td>Memory-mapped I/O</td>
</tr>
<tr>
<td>$FF80</td>
<td>$FFFF</td>
<td>128</td>
<td>&quot;High&quot; RAM</td>
</tr>
</tbody>
</table>
<h3>Memory Bank Controllers</h3>
<p>Gameboy cartridges often also use a Memory Bank Controller (MBC), which allows
swapping out regions of ROM and RAM at runtime, as well as other features.
Without this it would be impossible to access more than 32768 bytes of ROM.</p>
<p>Pokémon Blue uses MBC3, which has the ability to swap 64 different 16KiB banks
of ROM (for a total of 1MiB), as well as 4 different of 8KiB banks of External
Ram (for a total of 32KiB). The Pokémon Blue cartridge also has support for a
real-time clock, but I didn't implement support for that.</p>
<p>The way you communicate with the MBC is by writing to various address regions
in ROM (i.e. in the range <code>$0000-$7FFF</code>). See the following table for details.
The features that are unimplemented in pokegb have been struck through:</p>
<table>
<thead>
<tr>
<th>Low</th>
<th>High</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>$0000</td>
<td>$1FFF</td>
<td><s>External RAM and timer enable</s></td>
</tr>
<tr>
<td>$2000</td>
<td>$3FFF</td>
<td>ROM bank number</td>
</tr>
<tr>
<td>$4000</td>
<td>$5FFF</td>
<td>RAM bank number <s>(or RTC register select)</s></td>
</tr>
<tr>
<td>$6000</td>
<td>$7FFF</td>
<td><s>Latch clock data</s></td>
</tr>
</tbody>
</table>
<p>Reading and writing to external RAM can be enabled and disabled. I believe this
was used because the CPU may write garbage data to memory when losing power
(e.g. when the gameboy is switched off). We don't care about that, so we'll
skip implementing it. Fortunately, as far as I can tell, the game doesn't ever
read from or write to this region when it is disabled.</p>
<p>As mentioned before, the cartridge is 1MiB, but the CPU address space is only
64KiB. So to access the rest of the cartridge data we have to remap ROM. Only
ROM bank 1 can be remapped; ROM bank 0 is always mapped to the cartridge's
first 16KiB chunk.</p>
<p>The mapped memory region in ROM bank 1 can be changed by writing a value
between 0 and 63 to any address in the region <code>$2000-$3FFF</code>. So for example, if
we write the value 5 to address <code>$2000</code>, then the data mapped to addresses
<code>$4000-$7FFF</code> will reference the sixth 16KiB ROM bank of the cartridge (which
are the bytes in range <code>$14000-$17FFF</code>). The one exception is that if bank 0 is
selected, then the cartridge's second ROM bank is selected instead of the
first.</p>
<p>Similarly, the external RAM address space is only 8KiB, but the available RAM
is 32KiB. Writing a value between 0 and 3 to <code>$4000-$5FFF</code> will select a RAM
bank.</p>
<h3>Memory-mapped I/O</h3>
<p>The gameboy has 128 bytes of memory-mapped I/O, from address <code>$FF00</code> to
<code>$FF7F</code>. These addresses are sometimes called registers, not to be confused
with the CPU registers. Not all of these addresses are used by the gameboy, and
not all of the valid addresses are used by Pokémon Blue, and not all of the
addresses used by Pokémon Blue are implemented in pokegb!</p>
<p>Here is a list of the registers used by the original gameboy, with the
unimplemented ones struck through:</p>
<table>
<thead>
<tr>
<th>Low</th>
<th>High</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>$FF00</td>
<td>$FF00</td>
<td>JOYP</td>
<td>Joypad input</td>
</tr>
<tr>
<td>$FF01</td>
<td>$FF02</td>
<td>SB / SC</td>
<td><s>Serial communication</s></td>
</tr>
<tr>
<td>$FF04</td>
<td>$FF04</td>
<td>DIV</td>
<td>Clock divider</td>
</tr>
<tr>
<td>$FF05</td>
<td>$FF07</td>
<td>TIMA / TMA / TAC</td>
<td><s>Timer counter / modulo / control</s></td>
</tr>
<tr>
<td>$FF0F</td>
<td>$FF0F</td>
<td>IF</td>
<td>Interrupt request</td>
</tr>
<tr>
<td>$FF10</td>
<td>$FF3F</td>
<td>-</td>
<td><s>Sound</s></td>
</tr>
<tr>
<td>$FF40</td>
<td>$FF40</td>
<td>LCDC</td>
<td>LCD control</td>
</tr>
<tr>
<td>$FF41</td>
<td>$FF41</td>
<td>STAT</td>
<td><s>LCD status</s></td>
</tr>
<tr>
<td>$FF42</td>
<td>$FF43</td>
<td>SCY / SCX</td>
<td>Background scroll registers</td>
</tr>
<tr>
<td>$FF44</td>
<td>$FF44</td>
<td>LY</td>
<td>Current Y line being drawn</td>
</tr>
<tr>
<td>$FF45</td>
<td>$FF45</td>
<td>LYC</td>
<td><s>Y line compare</s></td>
</tr>
<tr>
<td>$FF46</td>
<td>$FF46</td>
<td>DMA</td>
<td>DMA transfer to OAM</td>
</tr>
<tr>
<td>$FF47</td>
<td>$FF47</td>
<td>BGP</td>
<td>Background palette</td>
</tr>
<tr>
<td>$FF48</td>
<td>$FF49</td>
<td>OBP0 / OBP1</td>
<td>Object palettes</td>
</tr>
<tr>
<td>$FF4A</td>
<td>$FF4B</td>
<td>WY / WX</td>
<td>Window location</td>
</tr>
<tr>
<td>$FFFF</td>
<td>$FFFF</td>
<td>IE</td>
<td>Interrupt enable</td>
</tr>
</tbody>
</table>
<p>Unfortunately, sound is completely skipped in pokegb. It would be fun to have,
but would require a lot more code, I think.</p>
<p>Several of the registers are used as full 8-bit values (<code>DIV</code>, <code>SCY</code>, <code>SCX</code>,
<code>LY</code>, <code>WY</code>, <code>WX</code>). Others give meaning to individual bits:</p>
<table>
<thead>
<tr>
<th>Register</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>JOYP</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>JOYP (reading directions)</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>~Down</td>
<td>~Up</td>
<td>~Left</td>
<td>~Right</td>
</tr>
<tr>
<td>JOYP (reading buttons)</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>~Start</td>
<td>~Select</td>
<td>~B</td>
<td>~A</td>
</tr>
<tr>
<td>LCDC</td>
<td>LCD enable</td>
<td>Window tile map</td>
<td>Window enable</td>
<td>BG/Window tile data</td>
<td>BG tile map</td>
<td><s>Object size</s></td>
<td>Object enable</td>
<td><s>BG/Window enable</s></td>
</tr>
<tr>
<td>IF</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td><s>Joypad</s></td>
<td><s>Serial</s></td>
<td><s>Timer</s></td>
<td><s>LCD STAT</s></td>
<td>Vblank</td>
</tr>
<tr>
<td>IE</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td><s>Joypad</s></td>
<td><s>Serial</s></td>
<td><s>Timer</s></td>
<td><s>LCD STAT</s></td>
<td>Vblank</td>
</tr>
<tr>
<td>BGP <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OBP0 <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OBP1 <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>As can be seen from the table, reading from the joypad gives different values
depending on whether bits 4 or 5 of <code>JOYP</code> are 0. Typically the program will
write to JOYP to read the directions and buttons separately, then later combine
them into one byte. Also, the buttons are labeled with a leading ~ because they
are inverted; e.g. the up direction is pressed when bit 2 is 0.</p>
<p><code>LCDC</code> has a few bits to enable/disable the various rendering layers:
background, window and objects (i.e. sprites). It also has some bits to choose
which region of video RAM is used for map and tile data:</p>
<table>
<thead>
<tr>
<th>Bit</th>
<th>0</th>
<th>1</th>
</tr>
</thead>
<tbody>
<tr>
<td>Window tile map</td>
<td>$9800-$9BFF</td>
<td>$9C00-$9FFF</td>
</tr>
<tr>
<td>BG/Window tile data</td>
<td>$8800-$97FF</td>
<td>$8000-$8FFF</td>
</tr>
<tr>
<td>BG tile map</td>
<td>$9800-$9BFF</td>
<td>$9C00-$9FFF</td>
</tr>
</tbody>
</table>
<p>The <code>IF</code> and <code>IE</code> request and enable various interrupt sources, respectively.
If a given interrupt is requested and enabled, and the Interrupt Master Enable
flag (IME) is enabled, then an interrupt is fired. This will cause the CPU to
stop normal execution and jump to an address for the &quot;interrupt handler&quot;, the
code that will respond to the interrupt, then return control back to the main
program. Of all of the possible sources, pokegb only supports the vblank
interrupt. The timer and serial interrupts are also used by Pokémon Blue, but
are not implemented.</p>
<p>Finally, the <code>BGP</code>, <code>OBP0</code>, and <code>OBP1</code> registers pick a palette color for the
background and sprites. When rendering graphics, the gameboy can pick from 4
color values, each of which is an index into the appropriate palette. The
palette then chooses what those color values mean:</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Color</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>White</td>
</tr>
<tr>
<td>1</td>
<td>Light gray</td>
</tr>
<tr>
<td>2</td>
<td>Dark gray</td>
</tr>
<tr>
<td>3</td>
<td>Black</td>
</tr>
</tbody>
</table>
<p>For pokegb, I decided to use a more fun palette with different colors for BGP,
OBP0, and OBP1.</p>
<h3>Graphics</h3>
<p>The gameboy has a 160x144 pixel LCD screen. The graphics hardware (also known
as a Picture Processing Unit or PPU) has the ability to draw one 32x32
scrollable background layer, one 32x32 &quot;window&quot; layer, and up to 40 8x8- or
8x16-pixel sprites. It has 8192 bytes of video RAM to stores the tile and map
data. Each tile stores the pixel colors for an 8x8 block. The gameboy only has
4 colors, so each pixel's color can be represented with only 2 bits, or 4
pixels per byte. As a result, each tile is 16 bytes. The map is an array of
32x32 indexes into the tile data, one byte per tile. So the 32x32 background
and window maps each use 1024 bytes.</p>
<p>It turns out that Pokémon Blue uses the background, window and sprite layers,
but only uses 8x8-pixel sprites.</p>
<p>As shown above, the address of the BG and window maps can be chosen to be
either <code>$9800-$9BFF</code> or <code>$9C00-$9FFF</code>. Similarly the BG/Window tile data region
can be chosen to be either <code>$8000-$8FFF</code> or <code>$8800-$97FF</code>. Interestingly, if
<code>$8800-$97FF</code> is selected the tile indexes start at <code>$9000</code> and wrap around.
So, for example, tile index 127 is at address <code>$97F0</code> and tile index 255 is at
address <code>$8FF0</code>.</p>
<p>The way the gameboy actually renders the screen is fairly complex (see <a href="https://gbdev.io/pandocs/pixel_fifo.html">Pixel
FIFO in pandocs</a>), but we can cheat. Most games (including Pokémon
Blue) don't change any graphics settings while a scanline is drawing. So we can
draw each scanline as it finishes.</p>
<p>Each scanline takes 456 T-states (or 114 M-Cycles) to render. The current
T-state for this scanline is sometimes called a &quot;dot&quot;, which has a value
in the range <code>0-455</code>. There are a total of 144 scanlines, and 10 lines of
&quot;vertical blank&quot; for a total of 154 lines per screen. So the amount of time it
takes to render a full screen is 70224 T-states (or 17556 M-cycles).</p>
<p>The vertical blank (or vblank) scanlines are a holdover from CRT screens, which
needed this period to reset the electron gun to the upper-left corner of the
screen. This happens to be a useful feature for the gameboy too, even though it
uses an LCD screen instead, since it is a period when the PPU is not accessing
video RAM or other video hardware. This gives the software an opportunity to
update video RAM without affecting the on-screen visuals.</p>
<h3>Window</h3>
<p>The window layer is a region displayed over the background layer. It can be
enabled or disabled, and positioned with the <code>WX</code> and <code>WY</code> registers. When it
is enabled, it always starts at the location <code>(WX, WY - 7)</code> and covers the
background in a rectangular region toward the lower-right of the screen. It is
not scrolled by the <code>SCX</code> and <code>SCY</code> registers.</p>
<p>The window is used in Pokémon Blue to display the title credits, various
animations, menus, etc.</p>
<h3>Sprites</h3>
<p>The gameboy hardware supports up to 40 sprites per frame, and up to 10 sprites
per scanline. Each sprite is defined in the OAM and uses 4 bytes. The bytes are
laid out as follows:</p>
<table>
<thead>
<tr>
<th>Byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 <td colspan=8 class="td-colspan"> Y-coordinate - 16</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1 <td colspan=8 class="td-colspan"> X-coordinate - 8</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2 <td colspan=8 class="td-colspan"> Tile index</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Priority</td>
<td>Y-flip</td>
<td>X-flip</td>
<td>Palette</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>The x- and y-coordinates of the sprite is offset by 8 and 16 pixels,
respectively. This is done so a sprite can be displayed off the left or top
edge of the screen. The sprite will be displayed if the x-coordinate is in the
range 0-167 and the y-coordinate is in the range 0-161, inclusive.</p>
<p>Unlike the BG/Window, the sprite tile data is always at <code>$8000-$8FFF</code>, but
otherwise the tile data is displayed the same way.</p>
<p>The priority bit specifies whether this sprite is displayed in front of (0)
or behind (1) the background/window. You can see this effect in Pokémon Blue
when your player walks in the tall grass. It works because the Background color
0 is considered to be transparent, so the sprite will display through.</p>
<p>The x-flip and y-flip bits will flip the displayed sprite horizontally,
vertically, or both, but otherwise will not affect how the sprite is displayed.</p>
<p>The palette bit specifies whether to use <code>OBP0</code> or <code>OBP1</code> when displaying the
sprite.</p>
<h3>Tiles</h3>
<p>The background layer, window layer and sprite layer are all made up of 8x8
tiles. Each tile is 16 bytes, using 2 bits-per-pixel. For each pixel, there
is a low bit and a high bit. The low bit and high bits are stored in separate
bytes, where each byte stores one row:</p>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Row</th>
<th>Bit</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Row 0</td>
<td>Low bit</td>
</tr>
<tr>
<td>1</td>
<td>Row 0</td>
<td>High bit</td>
</tr>
<tr>
<td>2</td>
<td>Row 1</td>
<td>Low bit</td>
</tr>
<tr>
<td>3</td>
<td>Row 1</td>
<td>High bit</td>
</tr>
<tr>
<td>4</td>
<td>Row 2</td>
<td>Low bit</td>
</tr>
<tr>
<td>5</td>
<td>Row 2</td>
<td>High bit</td>
</tr>
<tr>
<td>6</td>
<td>Row 3</td>
<td>Low bit</td>
</tr>
<tr>
<td>7</td>
<td>Row 3</td>
<td>High bit</td>
</tr>
<tr>
<td>8</td>
<td>Row 4</td>
<td>Low bit</td>
</tr>
<tr>
<td>9</td>
<td>Row 4</td>
<td>High bit</td>
</tr>
<tr>
<td>10</td>
<td>Row 5</td>
<td>Low bit</td>
</tr>
<tr>
<td>11</td>
<td>Row 5</td>
<td>High bit</td>
</tr>
<tr>
<td>12</td>
<td>Row 6</td>
<td>Low bit</td>
</tr>
<tr>
<td>13</td>
<td>Row 6</td>
<td>High bit</td>
</tr>
<tr>
<td>14</td>
<td>Row 7</td>
<td>Low bit</td>
</tr>
<tr>
<td>15</td>
<td>Row 7</td>
<td>High bit</td>
</tr>
</tbody>
</table>
<p>So for example, if we wanted to draw the pokéball that Ash is tossing on the
title screen:</p>
<table>
<thead>
<tr>
<th>Row</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal3">3 <td class="pokepal3">3 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal2">2 <td class="pokepal1">1 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal1">1 <td class="pokepal1">1 <td class="pokepal2">2 <td class="pokepal3">3</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal3">3</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5 <td class="pokepal0">0 <td class="pokepal2">2 <td class="pokepal1">1 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal2">2 <td class="pokepal0">0 <td class="pokepal3">3</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>6 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">3 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>7 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal2">2 <td class="pokepal3">3 <td class="pokepal3">3 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>8 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Then we would separate the tile into two <a href="https://en.wikipedia.org/wiki/Bit_plane">bit planes</a>, where the low
bit plane only has the values 0 or 1, and the high bit plane only has the
values 0 or 2. If we add them together for each pixel, we'll get the image
above:</p>
<table>
<thead>
<tr>
<th>Row</th>
<th>Low byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
<th></th>
<th>High byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>$1C <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td>$1C <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>$2A <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0</td>
<td></td>
<td>$32 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>$4D <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal3">1</td>
<td></td>
<td>$73 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>$41 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1</td>
<td></td>
<td>$7F <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>$21 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1</td>
<td></td>
<td>$5D <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal3">2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>$22 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0</td>
<td></td>
<td>$22 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>$0C <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td>$1C <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal3">2 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>$00 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td>$00 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>We then interleave these bit planes as shown above to get the 16 bytes for this tile:</p>
<pre><code>$1C $1C $2A $32 $4D $73 $41 $7F $21 $5D $22 $22 $0C $1C $00 $00
</code></pre>
<p><img src="/assets/2021-06-03-pokegb3.gif" alt="fight-gif"></p>
<h2>Making Pokegb</h2>
<p>With that out of the way, I'd like to talk a little about how I made pokegb. I
started working on Monday, May 24th. I've already written a gameboy emulator
(<a href="https://github.com/binji/binjgb">binjgb</a>), so I knew some of what I'd have to do. But I didn't know a lot
about Pokémon Blue's code. The gameboy actually has a lot of features, and I
didn't know how many Pokémon Blue used. I was hoping that I could avoid
implementing a lot of them to keep the code small.</p>
<p>I decided to start by loading the game in binjgb and tracing the instructions.
The trace output looked like this:</p>
<pre><code>A:01 F:Z-HC BC:0013 DE:00d8 HL:014d SP:fffe PC:0100 (cy: 0) ppu:+0 |[00]0x0100: 00        nop
A:01 F:Z-HC BC:0013 DE:00d8 HL:014d SP:fffe PC:0101 (cy: 4) ppu:+0 |[00]0x0101: c3 50 01  jp $0150
A:01 F:Z-HC BC:0013 DE:00d8 HL:014d SP:fffe PC:0150 (cy: 20) ppu:+0 |[00]0x0150: fe 11     cp a,17
A:01 F:-N-C BC:0013 DE:00d8 HL:014d SP:fffe PC:0152 (cy: 28) ppu:+0 |[00]0x0152: 28 03     jr z,+3
A:01 F:-N-C BC:0013 DE:00d8 HL:014d SP:fffe PC:0154 (cy: 36) ppu:+0 |[00]0x0154: af        xor a,a
A:00 F:Z--- BC:0013 DE:00d8 HL:014d SP:fffe PC:0155 (cy: 40) ppu:+0 |[00]0x0155: 18 02     jr +2
A:00 F:Z--- BC:0013 DE:00d8 HL:014d SP:fffe PC:0159 (cy: 52) ppu:+0 |[00]0x0159: ea 1a cf  ld [$cf1a],a
A:00 F:Z--- BC:0013 DE:00d8 HL:014d SP:fffe PC:015c (cy: 68) ppu:+0 |[00]0x015c: c3 54 1f  jp $1f54
...
</code></pre>
<p>This prints out the CPU state after each instruction, along with a disassembly.</p>
<p>When I started pokegb, I spent most of the first few days implementing the CPU.
Every time I hit an instruction that wasn't implemented, I'd implement it and
see if it would run any further. I made pokegb write a trace output similar to
binjgb, so I could see if they were diverging. Pokegb was significantly less
accurate so unfortunately I couldn't just diff the two trace outputs. Instead I
had to spot check them to see if the output looked way off.</p>
<p>After a few days, the CPU seemed to be in good shape. The game ran for millions
of instructions without failing, and matched binjgb pretty closely. At that
point I started working on rendering the graphics, and added some input. To my
surprise, everything seemed to come together pretty quickly at that point! I
only had a few more instructions to implement, and I was able to walk around,
have conversations, and have battles. I'll admit that I haven't played very far
into the game, so there are very likely bugs!</p>
<p><img src="/assets/2021-06-03-pokegb11.gif" alt="caterpillar-gif"></p>
<h2>Code</h2>
<p>Let's dive into the obfuscated code. I've made <a href="https://gist.github.com/binji/395669d45e9005950232043ab4378abe">an unobfuscated
version</a>, where I've given the variables better names and
formatted it using clang-format, but have otherwise not changed it.</p>
<p>Let's start at the top.</p>
<h3>Opcode Macros</h3>
<p>As mentioned above, most instructions can be grouped into one of ~40
categories. To make it easier to group them, I made 10 different macros:
<code>OP4_NX8</code>, <code>OP4_NX16_REL</code>, <code>OP5_FLAG</code>, <code>OP8_NX8_REL</code>, <code>OP7_PTR</code>, <code>OP7_NX8</code>,
<code>OP7_NX8_PTR</code>, <code>OP49_REL</code>, <code>OP56_PTR_REL</code>, <code>OP9_IMM_PTR</code>.</p>
<p>The naming convention I've used is as follows:</p>
<ul>
<li><code>OPn</code>: This macro defines <code>n</code> instructions.</li>
<li><code>NXm</code>: Each instruction is spaced out by multiples of <code>m</code>.</li>
<li><code>PTR</code>: This macro also sets the <code>ptr8</code> variable, which points to the address
of the 8-bit source register.</li>
<li><code>REL</code>: This macro also sets the <code>opcode_rel</code> variable, which is the offset of
the given opcode in its group (e.g. <code>OP4_NX16_REL</code> will have <code>opcode_rel</code>
values of 0, 16, 32, or 48). This can be helpful for indexing into a register
array.</li>
<li><code>IMM</code>: This macro also defines the &quot;immediate&quot; instruction e.g, <code>ADD A, u8</code>.</li>
<li><code>FLAG</code>: This macro defines an instruction that uses the <code>condition</code> codes as
well as its unconditional version, e.g. <code>CALL NZ, u16</code> and <code>CALL u16</code>.</li>
</ul>
<p>Let's take a look at some of the more interesting macros:</p>
<p>First up is <code>OP5_FLAG</code>. This macro defines 4 conditional instructions, as well
as the unconditional version. Here the variable <code>carry</code> is re-purposed to
determine whether the operation should be performed:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> OP5_FLAG(_, always)                                                    \<br><span class="highlight-line">  OP4_NX8(_)                                                                   \</span><br><span class="highlight-line">  case always:                                                                 \</span><br><span class="highlight-line">    carry = (opcode == always) ||                                              \</span><br>            (F &amp; F_mask[(opcode - _) / 8]) == F_equals[(opcode - _) / 8];</span></code></pre>
<p>The <code>F_mask</code> and <code>F_equals</code> arrays are defined to encode
the <code>condition</code> table above, and <code>F</code> is the flag register:</p>
<p>For example, the condition <code>NZ</code> means to execute the instruction if the <code>Z</code>
flag is not set. The <code>Z</code> flag is bit 7 of the flags register, or 128 in
decimal. So we can tell if <code>Z</code> is not set by calculating <code>(F &amp; 128) == 0</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">int</span> F_mask<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    F_equals<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>Next is <code>OP9_IMM_PTR</code>. This macro defines 9 instructions, one for each entry in
the <code>r8</code> table above, as well as for the immediate instruction (which is always
at an offset of 70). Each of these instructions operate on an 8-bit operand:
one of the 7 registers (<code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code>, <code>H</code>, or <code>L</code>), the byte at
address <code>HL</code>, or the immediate value <code>u8</code>.</p>
<p>The <code>read8_pc()</code> function reads the next byte at <code>PC</code> (i.e. the next byte in
the instruction stream). The <code>read8()</code> function can read a byte at any address,
but defaults to reading the byte at <code>HL</code>. And as mentioned above, <code>ptr8</code> points
to one of the 8-bit registers.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> OP9_IMM_PTR(_)                                                         \<br><span class="highlight-line">  case _ + 6:                                                                  \</span><br><span class="highlight-line">  case _ + 70:                                                                 \</span><br><span class="highlight-line">    OP7_PTR(_)                                                                 \</span><br><span class="highlight-line">    operand = (opcode == _ + 6)    ? read8()                                   \</span><br><span class="highlight-line">              : (opcode == _ + 70) ? read8_pc()                                \</span><br>                                   : *ptr8;</span></code></pre>
<h3>Registers</h3>
<p>It's convenient to be able to access most registers both as their 16-bit pairs
or their 8-bit parts. So all CPU registers are defined in an array, along with
their initial values.</p>
<p>These are defined in the order <code>C</code>, <code>B</code>, <code>E</code>, <code>D</code>, <code>L</code>, <code>H</code>, <code>F</code>, <code>A</code>,
<code>SP Low</code>, <code>SP High</code>. This allows us to read a 16-bit register pair directly as
long as the host machine is little-endian. Note that SP is never accessed as an
8-bit register, so it doesn't need to be defined here; this may be a place
where I could save some additional bytes.</p>
<p>The <code>A</code> and <code>F</code> registers are used for many of the instructions directly, so we
create references to them by name.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> reg8<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">216</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">176</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">254</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token operator">&amp;</span>F <span class="token operator">=</span> reg8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token operator">&amp;</span>A <span class="token operator">=</span> reg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>r8</code> group described above uses the order <code>B, C, D, E, F, H, L, (HL), A</code>.
The <code>reg8_group</code> array matches this, but uses <code>&amp;F</code> instead. This is never
actually used, so it could have been 0 instead to save a byte.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token operator">*</span>reg8_group<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>reg8 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> reg8<span class="token punctuation">,</span></span><br><span class="highlight-line">                         reg8 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> reg8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                         reg8 <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> reg8 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                         <span class="token operator">&amp;</span>F<span class="token punctuation">,</span>       <span class="token operator">&amp;</span>A<span class="token punctuation">}</span></span></code></pre>
<p>There are three <code>r16</code> groups above, and each are represented here, with <code>reg16</code>
being <code>r16 (group 3)</code>. Group 2 is actually meant to be <code>BC, DE, HL+, HL-</code>,
where <code>HL+</code> and <code>HL-</code> use the current value of <code>HL</code> and then increment or
decrement, respectively. That behavior is not included here, but instead used
directly in the instructions' implementations via the <code>HL_add</code> array.</p>
<p>As with <code>A</code> and <code>F</code>, <code>HL</code> and <code>SP</code> are often used directly, so we've created
references to them by name.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint16_t</span> PC <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span></span><br><span class="highlight-line">         <span class="token operator">*</span>reg16 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>reg8<span class="token punctuation">,</span></span><br><span class="highlight-line">         <span class="token operator">*</span>reg16_group1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>reg16<span class="token punctuation">,</span> reg16 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>HL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SP<span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">         <span class="token operator">*</span>reg16_group2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>reg16<span class="token punctuation">,</span> reg16 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>HL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>HL<span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">         <span class="token operator">&amp;</span>HL <span class="token operator">=</span> reg16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>SP <span class="token operator">=</span> reg16<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">int</span> HL_add<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>Finally, there is a helper function for setting CPU flags. The <code>mask</code> parameter
masks out any flags that are supposed to be set by this instruction, then the
<code>Z</code>, <code>N</code>, <code>H</code>, <code>C</code> parameters will set it to their new value. As a size
optimization, the <code>Z</code> flag is negated here. That's because many instructions
set the Z flag if the instruction produces a 0 result, so it's convenient to
do the logical not here rather than all places that call <code>set_flags()</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">void</span> <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> mask<span class="token punctuation">,</span> <span class="token keyword">int</span> Z<span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">,</span> <span class="token keyword">int</span> H<span class="token punctuation">,</span> <span class="token keyword">int</span> C<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  F <span class="token operator">=</span> <span class="token punctuation">(</span>F <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">!</span>Z <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> N <span class="token operator">*</span> <span class="token number">64</span> <span class="token operator">+</span> H <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> C <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<h3>Memory</h3>
<p>All the memory for the system is stored in static arrays or memory-mapped regions.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token operator">*</span>rom0<span class="token punctuation">,</span> <span class="token operator">*</span>rom1<span class="token punctuation">,</span> <span class="token operator">*</span>extram<span class="token punctuation">,</span> <span class="token operator">*</span>extrambank<span class="token punctuation">;</span></span></code></pre>
<ul>
<li><code>rom0</code>: a pointer to the first 16KiB bank of ROM (addresses <code>$0000-$3FFF</code>).
This is memory-mapped at the beginning of the program.</li>
<li><code>rom1</code>: a pointer to the currently mapped bank of ROM1 (addresses
<code>$4000-$7FFF</code>).</li>
<li><code>extram</code>: a pointer to the entire 32KiB of External RAM. This is
memory-mapped at the beginning of the program.</li>
<li><code>extrambank</code>: A pointer to the currently mapped 8KiB of External RAM.</li>
</ul>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> io<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> video_ram<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">,</span> work_ram<span class="token punctuation">[</span><span class="token number">16384</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<ul>
<li><code>io</code>: the 512 bytes from addresses <code>$FE00-$FFFF</code>; this includes OAM, I/O, and
high RAM.</li>
<li><code>video_ram</code>: 8KiB bytes of video RAM.</li>
<li><code>work_ram</code>: 16KiB of work RAM, used by the game for any purpose.</li>
</ul>
<p>The registers <code>IF</code>, <code>LCDC</code>, <code>LY</code>, and <code>DIV</code> are used enough times that it saves
source code to reference them by name, rather than via the <code>io</code> array:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token operator">&amp;</span>IF <span class="token operator">=</span> io<span class="token punctuation">[</span><span class="token number">271</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>LCDC <span class="token operator">=</span> io<span class="token punctuation">[</span><span class="token number">320</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>LY <span class="token operator">=</span> io<span class="token punctuation">[</span><span class="token number">324</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>DIV <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span>io<span class="token punctuation">[</span><span class="token number">259</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>frame_buffer</code> is a <code>160 * 144 = 23040</code> buffer, with an <code>int</code> for each
pixel. I assume that an <code>int</code> is 4-bytes, so it can store a 32-bit RGBA value.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">int</span> frame_buffer<span class="token punctuation">[</span><span class="token number">23040</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">int</span> palette<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token operator">-</span><span class="token number">23197</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token number">65536</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16777216</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token operator">-</span><span class="token number">8092417</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                 <span class="token operator">-</span><span class="token number">12961132</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16777216</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token operator">-</span><span class="token number">23197</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token number">65536</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16777216</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>The palette values look strange, but they are stored as signed-integers to save
in source code size. When written as hexadecimal values, they look more
natural. (Note that these values are stored so the red channel is the
least-significant byte and the alpha channel is the most-significant byte):</p>
<table>
<thead>
<tr>
<th>Palette</th>
<th>Color 0</th>
<th>Color 1</th>
<th>Color 2</th>
<th>Color 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>BGP</td>
<td><code class="pokepal4">0xffffffff</code></td>
<td><code class="pokepal5">0xffffa563</code></td>
<td><code class="pokepal6">0xffff0000</code></td>
<td><code class="pokepal7">0xff000000</code></td>
</tr>
<tr>
<td>OBP0</td>
<td><code class="pokepal0">0xffffffff</code></td>
<td><code class="pokepal1">0xff8484ff</code></td>
<td><code class="pokepal2">0xff3a3a94</code></td>
<td><code class="pokepal3">0xff000000</code></td>
</tr>
<tr>
<td>OBP1</td>
<td><code class="pokepal4">0xffffffff</code></td>
<td><code class="pokepal5">0xffffa563</code></td>
<td><code class="pokepal6">0xffff0000</code></td>
<td><code class="pokepal7">0xff000000</code></td>
</tr>
</tbody>
</table>
<h3>Memory Access</h3>
<p>The CPU can only read or write one byte at a time. The <code>mem_access()</code> function
implements both reading and writing to save on source code size. If <code>write == 0</code> then <code>val</code> is ignored. If <code>write != 0</code>, then the return value is ignored.</p>
<p>First, note that all memory accesses call <code>tick()</code>. This increments the cycle
counter by 4, which is the number of T-states required to do an 8-bit memory
access.</p>
<p>As a size-optimization, both <code>read8()</code> and <code>write8()</code> take <code>HL</code> as the default
address. This requires <code>write8()</code> to be written &quot;backward&quot;, with <code>val</code> as the
first parameter and <code>addr</code> as the second.</p>
<p>In <code>mem_access()</code>, the address is shifted right by 12. This extracts the top
nibble of the address, which can then be used to determine which region of
memory was accessed.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cycles <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token function">mem_access</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> addr<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span> val<span class="token punctuation">,</span> <span class="token keyword">int</span> write<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>addr <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> addr <span class="token operator">=</span> HL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">mem_access</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">void</span> <span class="token function">write8</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> val<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> addr <span class="token operator">=</span> HL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">mem_access</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span></code></pre>
<p>For cases 2 and 3, the address being accessed is in the range <code>$2000-$3FFF</code>. If
this region is written to, it will remap ROM bank 1 (see the Memory Bank
Controllers section above). The bank number is shifted left by 14, since each
bank is 1 &lt;&lt; 14 = 16KiB.</p>
<p>Either way, we fall through to cases 0 and 1 below. For 0 and 1, the address
being accessed is in the range <code>$0000-$1FFF</code>, which is in ROM bank 0.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span></span><br><span class="highlight-line">    rom1 <span class="token operator">=</span> rom0 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">?</span> val <span class="token operator">&amp;</span> <span class="token number">63</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> rom0<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>For cases 4 and 5, the address being accessed is in the range <code>$4000-5FFF</code>. If
the region is written to, it will remap the External RAM bank. Either way, we
fall through to cases 6 and 7 below, which covers the ROM bank 1 region.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>write <span class="token operator">&amp;&amp;</span> val <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    extrambank <span class="token operator">=</span> extram <span class="token operator">+</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> rom1<span class="token punctuation">[</span>addr <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Cases 8 and 9 are the video RAM region, addresses <code>$8000-$9FFF</code>. On the real
gameboy the video RAM cannot be updated during certain times (e.g. when the PPU
is accessing it), but we assume the game is well-behaved and allow it at all
times.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span></span><br><span class="highlight-line">  addr <span class="token operator">&amp;=</span> <span class="token number">8191</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span></span><br><span class="highlight-line">    video_ram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> video_ram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Cases 10 and 11 are in the external RAM region, addresses <code>$A000-$BFFF</code>. On
real gameboy there are ways to disable read and write access to this region,
but again we assume that the game is well-behaved and allow it at all times.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span></span><br><span class="highlight-line">  addr <span class="token operator">&amp;=</span> <span class="token number">8191</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span></span><br><span class="highlight-line">    extrambank<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> extrambank<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Case 15 is the most complex. Here we first test if the address is greater than
or equal to 65024 (<code>$FE00</code>). If so, then we know that we're accessing
somewhere in the <code>io</code> region, which includes OAM, I/O, and High RAM.</p>
<p>If the address is a write to 65350 (<code>$FF46</code>), then the game is requesting a
DMA transfer to OAM. This is an extremely common way for games to copy sprite
data into OAM, since it is much faster than having the CPU do it manually. The
value written to <code>$FF46</code> is used as the high byte of the source address. So,
for example, if the value is <code>$C1</code>, then 160 bytes will be copied from
<code>$C100-$C19F</code> to OAM.</p>
<p>If the address read from is 65280 (<code>$FF00</code>), then the game is reading the
<code>JOYP</code> register which gives the current joypad state. The value returned
depends on what was previously written to <code>JOYP</code>, either the directions buttons
if bit 4 of <code>JOYP</code> is 0, or the face buttons if bit 5 of <code>JOYP</code> is 0. If
neither is 0, then <code>JOYP</code> returns 255 (<code>$FF</code>).</p>
<p>Finally, if the memory access address is less than 65024, then it must be an
access to work RAM, either the primary address range at <code>$C000-$DFFF</code>, or the
mirror range at <code>$E000-$FDFF</code>. In either case the address is masked and a write
or read is performed.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">>=</span> <span class="token number">65024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">65350</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">;</span> <span class="token operator">--</span>y <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          io<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mem_access</span><span class="token punctuation">(</span>val <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">      io<span class="token punctuation">[</span>addr <span class="token operator">&amp;</span> <span class="token number">511</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">65280</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>io<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">+</span> key_state<span class="token punctuation">[</span>SDL_SCANCODE_DOWN<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_UP<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_LEFT<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_RIGHT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>io<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">+</span> key_state<span class="token punctuation">[</span>SDL_SCANCODE_RETURN<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_TAB<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_Z<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span></span><br><span class="highlight-line">                 key_state<span class="token punctuation">[</span>SDL_SCANCODE_X<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token keyword">return</span> <span class="token number">255</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> io<span class="token punctuation">[</span>addr <span class="token operator">&amp;</span> <span class="token number">511</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">12</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">14</span><span class="token operator">:</span></span><br><span class="highlight-line">  addr <span class="token operator">&amp;=</span> <span class="token number">16383</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>write<span class="token punctuation">)</span></span><br><span class="highlight-line">    work_ram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> work_ram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>A few more functions are used to reduce code size. First <code>read8_pc()</code>
(mentioned above), which reads a byte from the instruction stream.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">read8</span><span class="token punctuation">(</span>PC<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span></code></pre>
<p>Next <code>read16()</code>, which reads a 16-bit value from any address, but defaults to
<code>PC</code>. The gameboy CPU is little-endian, so this writes the least-significant
byte first. This function is also used to implement the <code>POP</code> instruction. Note
that <code>addr</code> must be incremented in separate statements to avoid undefined
behavior.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint16_t</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> <span class="token operator">&amp;</span>addr <span class="token operator">=</span> PC<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span>addr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">read8</span><span class="token punctuation">(</span>addr<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> tmp8<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Then <code>push()</code>, which pushes a 16-bit value onto the stack. The most-significant
byte is written first, because the value is written as <code>SP</code> is decremented.
Also note that the <code>tick()</code> is called because <code>PUSH</code> always takes an additional
M-cycle.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>val <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">--</span>SP<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token operator">--</span>SP<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<h3>Initialization</h3>
<p>The <code>main()</code> function begins by initializing the ROM and External RAM areas:</p>
<p>Since we know that Pokémon Blue is 1MiB, we can directly <code>mmap</code> it. This saves
some space over <code>fopen</code>/<code>fread</code> as long as we use numbers instead of
<code>PROT_READ</code>, etc.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  rom1 <span class="token operator">=</span> <span class="token punctuation">(</span>rom0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1048576</span><span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span></span><br><span class="highlight-line">                                 <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"rom.gb"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span></span><br><span class="highlight-line">         <span class="token number">32768</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Similarly, we can <code>mmap</code> the External RAM file, though this is even more
convenient since any writes to this region will automatically be written to the
save file.</p>
<p>One slightly annoying quirk is that the file must be truncated to the correct
length, or else writes will crash the emulator. This behavior seems to work on
Linux, but fails on macOS (see <a href="https://github.com/binji/pokegb/issues/1">pokegb issue 1</a>):</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">tmp <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"rom.sav"</span><span class="token punctuation">,</span> O_CREAT<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">ftruncate</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">extrambank <span class="token operator">=</span> extram <span class="token operator">=</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>LCDC</code> and <code>DIV</code> I/O registers are set to initial values to match binjgb.
It's likely that this isn't actually required, and could be removed to save
some bytes.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">LCDC <span class="token operator">=</span> <span class="token number">145</span><span class="token punctuation">;</span></span><br><span class="highlight-line">DIV <span class="token operator">=</span> <span class="token number">44032</span><span class="token punctuation">;</span></span></code></pre>
<p>Next we initialize SDL:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">SDL_Init</span><span class="token punctuation">(</span>SDL_INIT_VIDEO<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Then create a window at 5x the gameboy resolution, along with a renderer that can draw to it:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">SDL_Renderer <span class="token operator">*</span>renderer <span class="token operator">=</span> <span class="token function">SDL_CreateRenderer</span><span class="token punctuation">(</span></span><br><span class="highlight-line">    <span class="token function">SDL_CreateWindow</span><span class="token punctuation">(</span><span class="token string">"pokegb"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">720</span><span class="token punctuation">,</span> SDL_WINDOW_SHOWN<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    SDL_RENDERER_PRESENTVSYNC<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>And create a texture at the gameboy resolution that we will lock and draw to
later:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">SDL_Texture <span class="token operator">*</span>texture <span class="token operator">=</span> <span class="token function">SDL_CreateTexture</span><span class="token punctuation">(</span></span><br><span class="highlight-line">    renderer<span class="token punctuation">,</span></span><br><span class="highlight-line">    SDL_PIXELFORMAT_RGBA32<span class="token punctuation">,</span></span><br><span class="highlight-line">    SDL_TEXTUREACCESS_STREAMING<span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>And finally grab the keyboard state array. Conveniently, this will be
automatically updated by SDL whenever we poll for events:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">key_state <span class="token operator">=</span> <span class="token function">SDL_GetKeyboardState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p><img src="/assets/2021-06-03-pokegb6.gif" alt="old-man-gif"></p>
<h3>CPU</h3>
<p>After initialization, we start a loop that steps the CPU and updates the
graphics. There are a few different states that the CPU can be in: running
normally, &quot;halted&quot; waiting for an interrupt, and handling an interrupt.</p>
<p>That is all handled at the start of the loop:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  prev_cycles <span class="token operator">=</span> cycles<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>IME <span class="token operator">&amp;</span> IF <span class="token operator">&amp;</span> io<span class="token punctuation">[</span><span class="token number">511</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    IF <span class="token operator">=</span> halt <span class="token operator">=</span> IME <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    cycles <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    carry <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    temp16 <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">goto</span> CALL<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>halt<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">else</span></span><br><span class="highlight-line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>First, the the current cycle counter is saved so we know how many cycles to
update the PPU later. Then we check if any bit is set in all of Interrupt
Master Enable flag (<code>IME</code>), Interrupt Request (<code>IF</code>), and Interrupt Enable
(<code>io[511]</code>). Since pokegb only supports the vblank interrupt, then we know that
we only need to check for bit 0, but it's smaller to check for any bit here.</p>
<p>If an interrupt occurs, the CPU is no longer halting, and the <code>IME</code> and <code>IF</code>
flags are cleared. The CPU then performs the equivalent of a <code>CALL</code> to address
<code>$0040</code> (64) which is the vblank interrupt handler.</p>
<p>If the CPU is halted, then we simply tick the clock and loop until an interrupt
occurs.</p>
<p>Otherwise, we read the next byte in the instruction stream and try to execute
it.</p>
<p><img src="/assets/2021-06-03-pokegb8.gif" alt="no-entry-gif"></p>
<h3>Instructions</h3>
<p>This is the real meat of the emulator. As we saw above, there are a lot of
instructions, and most of them are needed to run Pokémon Blue. Let's start with
the simplest instruction, <code>NOP</code>, which does nothing:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">// NOP</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Off to a good start! Next is <code>LD r16, u16</code>, which copies a 16-bit value from
the instruction stream into a 16-bit register pair. This handles opcodes 1, 17,
33, and 49. Since these opcodes are spaced by multiples of 16, we can shift
right by 4 to index into <code>r16 (group 1)</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// LD r16, u16</span></span><br><span class="highlight-line">  <span class="token operator">*</span>reg16_group1<span class="token punctuation">[</span>opcode <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next up, <code>LD (r16), A</code>, which writes <code>A</code> into memory at a given address. This
also can optionally increment or decrement <code>HL</code>. Notice that we use
<code>opcode_rel</code> for this; it's not required in this case since <code>opcode / 16</code> is
equal to <code>opcode_rel / 16</code>. But for other instructions it will be useful:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// LD (r16), A</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token operator">*</span>reg16_group2<span class="token punctuation">[</span>opcode <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  HL <span class="token operator">+=</span> HL_add<span class="token punctuation">[</span>opcode_rel <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Then <code>INC r16</code> and <code>DEC r16</code>, which increment or decrement a register pair.
These take an additional M-cycle, so <code>tick()</code> is called.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// INC r16</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token operator">*</span>reg16_group1<span class="token punctuation">[</span>opcode <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment">// DEC r16</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token operator">*</span>reg16_group1<span class="token punctuation">[</span>opcode <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Likewise there are <code>INC r8</code> and <code>DEC r8</code> which increment or decrement an 8-bit
register. Unlike their 16-bit equivalents, these update CPU flags. <code>goto</code> is
used to share some code:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_NX8_PTR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// INC r8</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr8<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> INC_FLAGS<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP7_NX8_PTR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// DEC r8</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token operator">--</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr8<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> DEC_FLAGS<span class="token punctuation">;</span></span></code></pre>
<p>The <code>r8</code> group also includes <code>(HL)</code>, which means to use the byte at the address
<code>HL</code> instead. It is simpler to handle these separately, using <code>read8()</code> and
<code>write8()</code>.</p>
<p>These instructions also have the code to handle setting flags. Remember that
the first parameter is the mask. 16 is the value of the carry flag, so this
mask means that the carry flag will be preserved. The other flags are set
according to the rest of the arguments: <code>Z</code> is set if the result is zero, <code>N</code>
is set if the operation was a decrement, and <code>H</code> is set if there was an
overflow to bit 4 of the result.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">52</span><span class="token operator">:</span> <span class="token comment">// INC (HL)</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">INC_FLAGS<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> tmp8<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">!</span><span class="token punctuation">(</span>tmp8 <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">53</span><span class="token operator">:</span> <span class="token comment">// DEC (HL)</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">DEC_FLAGS<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> tmp8<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tmp8 <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next is <code>LD r8, u8</code>, which loads a value from the instruction stream into a
register or <code>(HL)</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_NX8_PTR</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment">// LD r8, u8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">54</span><span class="token operator">:</span> <span class="token comment">// LD (HL), u8</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span><span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next, <code>RLCA</code> and <code>RRCA</code>, which rotate the <code>A</code> register left or right by one
bit. The bit that is rotated out is copied to the carry flag, as well as moved
to the other end.</p>
<p><code>A += A</code> is used instead of <code>A &lt;&lt; 1</code>, and <code>A / 2</code> is used instead of <code>A &gt;&gt; 1</code>
to reduce code size.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> <span class="token comment">// RLCA</span></span><br><span class="highlight-line">  A <span class="token operator">+=</span> A <span class="token operator">+</span> <span class="token punctuation">(</span>carry <span class="token operator">=</span> A <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_FLAG<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span> <span class="token comment">// RRCA</span></span><br><span class="highlight-line">  A <span class="token operator">=</span> <span class="token punctuation">(</span>carry <span class="token operator">=</span> A <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> A <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_FLAG<span class="token punctuation">;</span></span></code></pre>
<p><code>RLA</code> is similar to <code>RLCA</code>, but it rotates the <code>A</code> register &quot;through&quot; the carry
flag, meaning that it is a 9-bit rotate. Bit 7 of <code>A</code> is moved into the carry
flag, and the carry flag is moved into bit 0 of <code>A</code>.</p>
<p>When the flags are set, the mask is 0, which means that all flags are set: <code>Z</code>
is always 1, <code>N</code> and <code>H</code> are 0, and <code>C</code> is set to <code>carry</code>:</p>
<p>The expression <code>F / 16 % 2</code> looks odd, but extracts the carry bit from <code>F</code> into
bit 0.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">23</span><span class="token operator">:</span> <span class="token comment">// RLA</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> A <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  A <span class="token operator">+=</span> A <span class="token operator">+</span> F <span class="token operator">/</span> <span class="token number">16</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">CARRY_FLAG<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> carry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Now onto the <code>JR</code> instructions. They branch the <code>PC</code> to a new location,
relative to where the current <code>PC</code> is, either forward or backward. That's why
<code>tmp8</code> is cast to an <code>int8_t</code>. The <code>carry</code> variable is used as a condition,
which is automatically set by the <code>OP5_FLAG</code> macro. Notice also that this uses
the comma operator to save a byte of source code.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP5_FLAG</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token comment">// JR i8 / JR &lt;condition>, i8</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>carry<span class="token punctuation">)</span></span><br><span class="highlight-line">    PC <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">int8_t</span><span class="token punctuation">)</span>tmp8<span class="token punctuation">,</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next is a beast of an instruction, Decimal Adjust for Addition (<code>DAA</code>). It's
intended to be used for handling arithmetic on <a href="https://en.wikipedia.org/wiki/Binary-coded_decimal">Binary Coded Decimal</a>
(BCD) values.</p>
<p>The basic idea is relatively simple: a two-digit decimal number can be stored
in a byte where each nibble stores one digit. For example, the decimal number
42 can be stored as the hexadecimal number <code>$42</code> (66). This is useful for
older harware that didn't have a divide instruction, like the gameboy.</p>
<p><code>DAA</code> is used after addition or subtraction to fix the BCD value. So if we take
the decimal numbers 42 and add 9, we expect to get 51. But if we do this with
BCD values, we'll get <code>$4B</code> instead. Executing <code>DAA</code> after this addition will
adjust <code>$4B</code> to <code>$51</code> as expected.</p>
<p>The first <code>if</code> determines whether we need to adjust the least-significant
nibble, and the second <code>if</code> determines whether we need to adjust the
most-significant nibble. The adjustment value added to (or subtracted from) <code>A</code>
is either <code>$00</code>, <code>$06</code>, <code>$60</code>, or <code>$66</code>, depending on the values of the <code>H</code>,
<code>C</code>, and <code>N</code> flags, and the current value of the <code>A</code> register.</p>
<p>For our example, <code>$06</code> will be added to <code>$4B</code> to produce <code>$51</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">39</span><span class="token operator">:</span> <span class="token comment">// DAA</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> tmp8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">32</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> A <span class="token operator">%</span> <span class="token number">15</span> <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    tmp8 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">16</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> A <span class="token operator">></span> <span class="token number">153</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    tmp8 <span class="token operator">|=</span> <span class="token number">96</span><span class="token punctuation">,</span> carry <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> A <span class="token operator">+=</span> <span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span>tmp8 <span class="token operator">:</span> tmp8<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> carry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span></code></pre>
<p>Now a simpler one, <code>CPL</code>. This instruction performs the <a href="https://en.wikipedia.org/wiki/Ones%27_complement">ones' complement</a> of
<code>A</code>, which means flipping all of its bits.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">47</span><span class="token operator">:</span> <span class="token comment">// CPL</span></span><br><span class="highlight-line">  A <span class="token operator">=</span> <span class="token operator">~</span>A<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">129</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p><code>SCF</code> and <code>CCF</code> set or complement the carry flag. The implementation combines
them to save on space.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">55</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">63</span><span class="token operator">:</span> <span class="token comment">// SCF / CCF</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> opcode <span class="token operator">==</span> <span class="token number">55</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>F <span class="token operator">&amp;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>LD r8, (HL)</code> and <code>LD (HL), r8</code> instructions read from or write to memory.
In this case there is an exception to the pattern; normally the <code>r8</code> group
includes <code>(HL)</code>, but there is no <code>LD (HL), (HL)</code> instruction. That instruction
is instead <code>HALT</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_NX8_PTR</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span> <span class="token comment">// LD r8, (HL)</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">)</span> <span class="token comment">// LD (HL), r8</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr8<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Speaking of which, here's <code>HALT</code>. On the real gameboy, there are some
complexities with how <code>HALT</code> behaves, but here we merely set the <code>halt</code>
variable to 1.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">118</span><span class="token operator">:</span> <span class="token comment">// HALT</span></span><br><span class="highlight-line">  halt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>LD r8, r8</code> group covers 49 different instructions, not including <code>(HL)</code>.
It has several seemingly redundant instructions, such as <code>LD B, B</code> and <code>LD C, C</code>. Some emulators use these instructions as a breakpoint instead, since they
otherwise have no purpose:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP49_REL</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment">// LD r8, r8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>reg8_group<span class="token punctuation">[</span>opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>reg8_group<span class="token punctuation">[</span>opcode <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Here's one of the trickier set of instructions. There are 4 different
operations handled here: addition (<code>ADD</code>), addition with carry (<code>ADC</code>),
subtraction (<code>SUB</code>), and subtraction with carry (<code>SBC</code>). In other words, each
instruction does the following:</p>
<ul>
<li><code>ADD</code>: <code>A = A + operand + 0</code></li>
<li><code>ADC</code>: <code>A = A + operand + carry</code></li>
<li><code>SUB</code>: <code>A = A - operand - 0</code></li>
<li><code>SBC</code>: <code>A = A - operand - carry</code></li>
</ul>
<p>They all can be implemented using the same code. In regular mathematics, we can
rewrite subtraction as addition (e.g. <code>3 - 5 = 3 + -5</code>). We can do the same for
<a href="https://en.wikipedia.org/wiki/Two%27s_complement">two's complement</a> arithmetic, but instead of negating the operand, we can
complement it (<code>~</code>) and add one, which is equivalent:</p>
<ul>
<li><code>ADD</code>: <code>A = A + operand + 0</code></li>
<li><code>ADC</code>: <code>A = A + operand + carry</code></li>
<li><code>SUB</code>: <code>A = A + ~operand + 1 - 0</code></li>
<li><code>SBC</code>: <code>A = A + ~operand + 1 - carry</code></li>
</ul>
<p>But since <code>carry</code> is either 0 or 1, we can simplify this to:</p>
<ul>
<li><code>ADD</code>: <code>A = A + operand + 0</code></li>
<li><code>ADC</code>: <code>A = A + operand + carry</code></li>
<li><code>SUB</code>: <code>A = A + ~operand + 1</code></li>
<li><code>SBC</code>: <code>A = A + ~operand + ~carry</code></li>
</ul>
<p>The only additional complication is how to deal with the flags. The <code>N</code> flag is
simplest, it is 0 for addition and 1 for subtraction. The <code>H</code> flag is set
if there is an overflow into bit 4 of the result. It turns out that we can
correctly calculate this by seeing if the sum of the low nibbles of <code>A</code>,
<code>operand</code>, and <code>carry</code> is greater than 15. For subtraction, we take this
result and flip it, i.e. we only set the <code>H</code> flag if the sum is <em>not</em> greater
than 15. Similarly, the <code>C</code> flag checks for an overflow out of bit 7 of the
result, so we check whether the sum <code>A + operand + carry</code> is greater than 255.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">// ADD A, r8 / ADD A, (HL) / ADD A, u8</span></span><br><span class="highlight-line">  neg <span class="token operator">=</span> carry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> ALU<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span> <span class="token comment">// ADC A, r8 / ADC A, (HL) / ADC A, u8</span></span><br><span class="highlight-line">  neg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> F <span class="token operator">/</span> <span class="token number">16</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> ALU<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">144</span><span class="token punctuation">)</span> <span class="token comment">// SUB A, r8 / SUB A, (HL) / SUB A, u8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> SUBTRACT<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">152</span><span class="token punctuation">)</span> <span class="token comment">// SBC A, r8 / SBC A, (HL) / SBC A, u8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>F <span class="token operator">/</span> <span class="token number">16</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">SUBTRACT<span class="token operator">:</span></span><br><span class="highlight-line">  neg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  operand <span class="token operator">=</span> <span class="token operator">~</span>operand<span class="token punctuation">;</span></span><br><span class="highlight-line">ALU<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tmp8 <span class="token operator">=</span> A <span class="token operator">+</span> operand <span class="token operator">+</span> carry<span class="token punctuation">,</span> neg<span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token punctuation">(</span>A <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">+</span> operand <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">+</span> carry <span class="token operator">></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">^</span> neg<span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token punctuation">(</span>A <span class="token operator">+</span> operand <span class="token operator">+</span> carry <span class="token operator">></span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">^</span> neg<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  A <span class="token operator">=</span> tmp8<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next are the common bitwise operations, <code>AND</code>, <code>OR</code>, and <code>XOR</code>. They are
relatively straightforward since c++ has built-in operators for them:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">)</span> <span class="token comment">// AND A, r8 / AND A, (HL) / AND A, u8</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> A <span class="token operator">&amp;=</span> operand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">168</span><span class="token punctuation">)</span> <span class="token comment">// XOR A, r8 / XOR A, (HL) / XOR A, u8</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> A <span class="token operator">^=</span> operand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">176</span><span class="token punctuation">)</span> <span class="token comment">// OR A, r8 / OR A, (HL) / OR A, u8</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> A <span class="token operator">|=</span> operand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Next up is the collection of <code>CP</code> instructions. They have the same behavior as
<code>SUB</code>, except they don't modify <code>A</code>, only the CPU flags:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP9_IMM_PTR</span><span class="token punctuation">(</span><span class="token number">184</span><span class="token punctuation">)</span> <span class="token comment">// CP A, r8 / CP A, (HL) / CP A, u8</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> A <span class="token operator">!=</span> operand<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> A <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">&lt;</span> operand <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">,</span> A <span class="token operator">&lt;</span> operand<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Now we get to the set of <code>RET</code> instructions. They return from a function call
by popping the return address off of the stack. Like the <code>JR</code> instructions
above, they come in &quot;conditional&quot; and &quot;unconditional&quot; flavors. The <code>OP5_FLAG</code>
macro sets <code>carry</code> to the result of the condition. But there's also <code>RETI</code>,
which is the same as <code>RET</code> followed by <code>EI</code> (enable interrupts).</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">217</span><span class="token operator">:</span> <span class="token comment">// RETI</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> IME <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> RET<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP5_FLAG</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">)</span> <span class="token comment">// RET / RET &lt;condition></span></span><br><span class="highlight-line">RET<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>carry<span class="token punctuation">)</span></span><br><span class="highlight-line">    PC <span class="token operator">=</span> <span class="token function">read16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Then onto <code>PUSH</code> and <code>POP</code> instructions. These write to or read from the stack,
and then move the stack pointer accordingly. They don't have to be used for
stack access, however. Pokémon Blue actually uses them to decode some graphics
during vblank, since <code>POP</code> is a fast way to read 16 bits into a register pair.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">193</span><span class="token punctuation">)</span> <span class="token comment">// POP r16</span></span><br><span class="highlight-line">  reg16<span class="token punctuation">[</span>opcode_rel <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">read16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP4_NX16_REL</span><span class="token punctuation">(</span><span class="token number">197</span><span class="token punctuation">)</span> <span class="token comment">// PUSH r16</span></span><br><span class="highlight-line">  <span class="token function">push</span><span class="token punctuation">(</span>reg16<span class="token punctuation">[</span>opcode_rel <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>JP</code> instructions is similar to the <code>JR</code> instructions, except that the jump
is absolute instead of relative.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP5_FLAG</span><span class="token punctuation">(</span><span class="token number">194</span><span class="token punctuation">,</span> <span class="token number">195</span><span class="token punctuation">)</span> <span class="token comment">// JP u16 / JP &lt;condition>, u16</span></span><br><span class="highlight-line">  temp16 <span class="token operator">=</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>carry<span class="token punctuation">)</span></span><br><span class="highlight-line">    PC <span class="token operator">=</span> temp16<span class="token punctuation">,</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>CALL</code> instructions are similar to the <code>JP</code> instructions, but the also push
the old <code>PC</code> to the stack first:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP5_FLAG</span><span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">,</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token comment">// CALL u16 / CALL &lt;condition>, u16</span></span><br><span class="highlight-line">  temp16 <span class="token operator">=</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">CALL<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>carry<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token function">push</span><span class="token punctuation">(</span>PC<span class="token punctuation">)</span><span class="token punctuation">,</span> PC <span class="token operator">=</span> temp16<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The gameboy also has some instructions to make it easier to access the top 256
bytes of the address space (<code>$FF00-$FFFF</code>). The byte offset is either read from
the instruction stream as <code>($FF00 + u8)</code> or from the <code>C</code> register as <code>($FF00 + C)</code>.</p>
<p>The <code>LD A, (u16)</code> instruction is also implemented here, which reads an address
from memory, then reads that byte into the <code>A</code> register. Its implementation is
combined with <code>LD A, ($FF00 + u8)</code> to save space.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">224</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">226</span><span class="token operator">:</span> <span class="token comment">// LD ($FF00 + u8), A / LD ($FF00 + C), A</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token number">65280</span> <span class="token operator">+</span> <span class="token punctuation">(</span>opcode <span class="token operator">==</span> <span class="token number">224</span> <span class="token operator">?</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">*</span>reg8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">240</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">250</span><span class="token operator">:</span> <span class="token comment">// LD A, ($FF00 + u8) / LD A, (u16)</span></span><br><span class="highlight-line">  A <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span>opcode <span class="token operator">==</span> <span class="token number">240</span> <span class="token operator">?</span> <span class="token number">65280</span> <span class="token operator">|</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The counterpart to <code>LD A, (u16)</code> is <code>LD (u16), A</code>, which reads an address from
the instruction stream, then writes the value in the <code>A</code> register to that
address. This probably could have been combined with case 224 and 226 above
to save space.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">234</span><span class="token operator">:</span> <span class="token comment">// LD (u16), A</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token function">read16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>All of the other jump instructions we've seen so far take an immediate offset
or address, but <code>JP HL</code> is used when you want to jump to an arbitrary address,
for example, to implement a jump table.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">233</span><span class="token operator">:</span> <span class="token comment">// JP HL</span></span><br><span class="highlight-line">  PC <span class="token operator">=</span> HL<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The Interrupt Master Enable (<code>IME</code>) flag can be modified with the <code>DI</code> and <code>EI</code>
instructions, either disabling or enabling the flag.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">243</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">251</span><span class="token operator">:</span> <span class="token comment">// DI / EI</span></span><br><span class="highlight-line">  IME <span class="token operator">=</span> opcode <span class="token operator">!=</span> <span class="token number">243</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>Finally, there are two instructions that copy between <code>HP</code> and <code>SP</code>. The <code>LD HL, SP + i8</code> adds a signed value to <code>SP</code> and stores it in the <code>HL</code> register. On
the other hand, <code>LD SP, HL</code> just copies the <code>HL</code> register directly into <code>SP</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">248</span><span class="token operator">:</span> <span class="token comment">// LD HL, SP + i8</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8_pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span>SP <span class="token operator">+</span> tmp8 <span class="token operator">></span> <span class="token number">255</span><span class="token punctuation">,</span> SP <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">+</span> tmp8 <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">></span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  HL <span class="token operator">=</span> SP <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int8_t</span><span class="token punctuation">)</span>tmp8<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">249</span><span class="token operator">:</span> <span class="token comment">// LD SP, HL</span></span><br><span class="highlight-line">  SP <span class="token operator">=</span> HL<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p><img src="/assets/2021-06-03-pokegb7.gif" alt="bug-catcher-gif"></p>
<h3>$CB Instructions</h3>
<p>The <code>$CB</code> instruction is an instruction prefix. All <code>$CB</code> instructions are two
bytes, and the second byte determines which operation it is (see opcode group 3
above).</p>
<p>First off are <code>RLC</code> and <code>RRC</code>, which are similar to <code>RLCA</code> and <code>RRCA</code> above but
can be used for any register (as well as <code>HL</code>) Interestingly, the <code>RRC (HL)</code>
instruction is also used by Pokémon Blue, but <code>RLC (HL)</code> doesn't seem to be. It
works the same as <code>RRC r8</code>, but operates on the memory at <code>(HL)</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// RLC r8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">+=</span> <span class="token operator">*</span>ptr8 <span class="token operator">+</span> <span class="token punctuation">(</span>carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">/</span> <span class="token number">128</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment">// RRC r8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token punctuation">(</span>carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> <span class="token operator">*</span>ptr8 <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span> <span class="token comment">// RRC (HL)</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> tmp8 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>tmp8 <span class="token operator">=</span> carry <span class="token operator">*</span> <span class="token number">128</span> <span class="token operator">+</span> tmp8 <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_TMP<span class="token punctuation">;</span></span></code></pre>
<p>Next are <code>RL</code> and <code>RR</code>. Like <code>RLA</code> and <code>RRA</code> above, these rotate &quot;through&quot; the
carry flag for a 9-bit rotate, but they can be used for any register.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// RL r8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> F <span class="token operator">/</span> <span class="token number">16</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token comment">// RR r8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>F <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span></code></pre>
<p>Now Shift Left Arithmetic (<code>SLA</code>) and Shift Right Arithmetic (<code>SRA</code>).
&quot;Arithmetic&quot; means that <code>SRA</code> behaves like a signed divide by 2. In two's
complement, that means that the most-significant bit (i.e. the sign bit) is not
changed. For example, performing <code>SRA</code> on <code>$43</code> (67 in decimal, <code>01000011</code> in
binary) results in <code>$21</code> (33 in decimal, <code>00100001</code> in binary). On the other
hand, performing <code>SRA</code> on <code>$F0</code> (-16 in decimal, <code>11110000</code> in binary)
results in <code>$F8</code> (-8 in decimal, <code>11111000</code> in binary).</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">// SLA r8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">/</span> <span class="token number">128</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token comment">// SRA r8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int8_t</span><span class="token punctuation">)</span><span class="token operator">*</span>ptr8 <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> CARRY_ZERO_FLAGS_PTR<span class="token punctuation">;</span></span></code></pre>
<p>On the other hand, Shift Right Logical (<code>SRL</code>) fills 0 into the
most-significant bit after a shift. So for example, performing <code>SRL</code> on <code>$F0</code>
(240 in decimal, <code>11110000</code> in binary) results in <code>$78</code> (120 in decimal,
<code>01111000</code> in binary).</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">)</span> <span class="token comment">// SRL r8</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">/=</span> <span class="token number">2</span><span class="token punctuation">;</span></span><br><span class="highlight-line">CARRY_ZERO_FLAGS_PTR<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr8<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> carry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>SWAP</code> instructions swap the low and high nibble of the byte. For example,
<code>SWAP</code> on <code>$A3</code> results in <code>$3A</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP7_PTR</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span> <span class="token comment">// SWAP r8</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr8 <span class="token operator">=</span> <span class="token operator">*</span>ptr8 <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token operator">*</span>ptr8 <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">case</span> <span class="token number">54</span><span class="token operator">:</span> <span class="token comment">// SWAP (HL)</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  carry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span>tmp8 <span class="token operator">=</span> tmp8 <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> tmp8 <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">CARRY_ZERO_FLAGS_TMP<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tmp8<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> carry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>BIT</code> instructions check whether a given bit is set, and set the <code>Z</code> flag
accordingly. The bit to check is encoded in the opcode itself, so we can use
<code>opcode_rel / 8</code> to extract it:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP8_NX8_REL</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span> <span class="token comment">// BIT bit, r8</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">goto</span> BIT_FLAGS<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP56_PTR_REL</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token comment">// BIT bit, (HL)</span></span><br><span class="highlight-line">  tmp8 <span class="token operator">=</span> <span class="token operator">*</span>ptr8<span class="token punctuation">;</span></span><br><span class="highlight-line">BIT_FLAGS<span class="token operator">:</span></span><br><span class="highlight-line">  <span class="token function">set_flags</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> tmp8 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>The <code>RES</code> instructions reset (i.e. clear) a given bit in an 8-bit register or
<code>(HL)</code>. Again, the bit to clear is encoded in the opcode.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP8_NX8_REL</span><span class="token punctuation">(</span><span class="token number">134</span><span class="token punctuation">)</span> <span class="token comment">// RES bit, (HL)</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span><span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP56_PTR_REL</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">// RES bit, r8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>And finally, the <code>SET</code> instructions set a given bit in an 8-bit register or
<code>(HL)</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">OP8_NX8_REL</span><span class="token punctuation">(</span><span class="token number">198</span><span class="token punctuation">)</span> <span class="token comment">// SET bit, (HL)</span></span><br><span class="highlight-line">  <span class="token function">write8</span><span class="token punctuation">(</span><span class="token function">read8</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token function">OP56_PTR_REL</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">)</span> <span class="token comment">// SET bit, r8</span></span><br><span class="highlight-line">  <span class="token operator">*</span>ptr8 <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> opcode_rel <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span></code></pre>
<p>With that, we've completed the CPU implementation, in 1955 bytes (after
removing all unnecessary whitespace).</p>
<p><img src="/assets/2021-06-03-pokegb5.gif" alt="heal-gif"></p>
<h3>Graphics</h3>
<p>Now that we've executed the CPU, we want the PPU to catch up. The current CPU
cycle count is in <code>cycles</code>, and the cycle count before executing the
instruction is in <code>prev_cycles</code>. So we can update the PPU by <code>cycles - prev_cycles</code> T-states.</p>
<p>The <code>DIV</code> I/O register counts the number of T-states as well, but only stores
the high byte of this value at address <code>$FF04</code>. Fortunately <code>$FF03</code> is left
unused, so we can treat <code>DIV</code> as a 16-bit value starting at <code>$FF03</code> instead,
and increment it directly:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span>DIV <span class="token operator">+=</span> cycles <span class="token operator">-</span> prev_cycles<span class="token punctuation">;</span> prev_cycles<span class="token operator">++</span> <span class="token operator">!=</span> cycles<span class="token punctuation">;</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span></code></pre>
<p>First off, we only want to draw the screen if the LCD is enabled (see <code>LCDC</code>
bit 7). So we check for that, and otherwise reset the current PPU dot and the
current scanline counter to zero (since it means that the screen is off):</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>LCDC <span class="token operator">&amp;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"><span class="token punctuation">}</span> <span class="token keyword">else</span></span><br><span class="highlight-line">  LY <span class="token operator">=</span> ppu_dot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span></code></pre>
<p>Next we want to trigger a vblank interrupt when the screen is finished
rendering. This happens after the 143rd line finishes, so we check whether the
current &quot;dot&quot; was 0, and whether the current scanline is 144, and set the
interrupt request to 1. This could have been just <code>IF=1</code>, since we don't
support any other interrupts:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>ppu_dot <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> LY <span class="token operator">==</span> <span class="token number">144</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  IF <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span></span></code></pre>
<p>After that is the fun bit, actually drawing a scanline! Since we're keeping
things simple, we only render a scanline when it finishes, at dot 456. It is
possible on the real gameboy to modify PPU settings during the scanline, but
those don't happen in Pokémon Blue.</p>
<p>After rendering the line, we increment <code>LY</code> and reset <code>ppu_dot</code> back to 0.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>ppu_dot <span class="token operator">==</span> <span class="token number">456</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  LY <span class="token operator">=</span> <span class="token punctuation">(</span>LY <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">154</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  ppu_dot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>If the current scanline is less than 144, we draw it. This includes rendering
the background and window layers, and any sprites that are on this line. We
loop over every x-coordinate as <code>tmp</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>LY <span class="token operator">&lt;</span> <span class="token number">144</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">;</span> <span class="token operator">--</span>tmp <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span></code></pre>
<p>First we want to determine if we're drawing the window layer or the background
layer. Like everything else, the real logic to determine this is somewhat
complex, but we can do a simpler version. If the window is enabled, and the
current pixel we're drawing <code>(tmp, LY)</code> is greater than the upper-left
coordinate of the window <code>(WX - 7, WY)</code>, then we are drawing the window. Recall
from above that <code>WY</code> is <code>io[330]</code> and <code>WX</code> is <code>io[331]</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> is_window <span class="token operator">=</span></span><br><span class="highlight-line">            LCDC <span class="token operator">&amp;</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span></span><br><span class="highlight-line">            LY <span class="token operator">>=</span> io<span class="token punctuation">[</span><span class="token number">330</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span></span><br><span class="highlight-line">            tmp <span class="token operator">>=</span> io<span class="token punctuation">[</span><span class="token number">331</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">;</span></span></code></pre>
<p>Now we want to find out the pixel offset of the current pixel, either into the
background map or the window map. If this pixel is displaying the background,
then we offset by the background scroll registers <code>(SCX, SCY)</code>. If instead this
pixel is displaying the window, then we offset by the window's upper left
corner <code>(WX - 7, WY)</code>. Again, note that <code>SCX</code> is <code>io[323]</code> and <code>SCY</code> is
<code>io[322]</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> x_offset <span class="token operator">=</span> is_window <span class="token operator">?</span> tmp <span class="token operator">-</span> io<span class="token punctuation">[</span><span class="token number">331</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">:</span> tmp <span class="token operator">+</span> io<span class="token punctuation">[</span><span class="token number">323</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        y_offset <span class="token operator">=</span> is_window <span class="token operator">?</span> LY <span class="token operator">-</span> io<span class="token punctuation">[</span><span class="token number">330</span><span class="token punctuation">]</span> <span class="token operator">:</span> LY <span class="token operator">+</span> io<span class="token punctuation">[</span><span class="token number">322</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Now that we know the pixel offset, we can determine which tile is being drawn.
The background and window maps start at either address <code>$9800</code> or <code>$9C00</code>,
depending on the settings in <code>LCDC</code>. Since we're reading from video RAM
directly (rather than through the <code>read8()</code> function), we want to use the
offset into video RAM instead, <code>$1800</code> or <code>$1C00</code>. This can be rewritten as <code>$6 &lt;&lt; 10</code> and <code>$7 &lt;&lt; 10</code>.</p>
<p>The window map is at <code>$1C00</code> if <code>LCDC</code> bit 6 is set (<code>== 64</code>), and the
background map is at <code>$1C00</code> if <code>LCDC</code> bit 3 is set (<code>== 8</code>). So we can
determine the base map address by checking the correct bit, depending on
<code>is_window</code>.</p>
<p>Finally, the tile offset within the map can be found by taking the pixel offset
and dividing by 8, since there are 8 pixels per tile in both dimensions.
The map is 32x32 tiles, and each tile is one byte, so multiplying the y tile
offset by 32 gives the final expression.</p>
<p>We also set the <code>palette_index</code> to 0 by default (which means to use <code>BGP</code>).</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint16_t</span> tile <span class="token operator">=</span></span><br><span class="highlight-line">  video_ram<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCDC <span class="token operator">&amp;</span> <span class="token punctuation">(</span>is_window <span class="token operator">?</span> <span class="token number">64</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">7</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span></span><br><span class="highlight-line">            y_offset <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> x_offset <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  palette_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span></code></pre>
<p>Now that we know which tile is being rendered, we have to read the pixel data
for that tile. The starting address of the tile data is either <code>$8000</code> or
<code>$8800</code>. But as mentioned above, if the starting address is <code>$8800</code>, then
tile 0 is actually at address <code>$9000</code>, and then the tile indexes wrap
around back to <code>$8800</code> at tile index 128. <code>LCDC</code> bit 4 (<code>== 16</code>) determines
this behavior.</p>
<p>We can get the pixel row of the tile to draw with the expression <code>y_offset % 8</code>. Each row is 2 bytes (since it has two bitplanes) and each tile is 16
bytes:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> <span class="token operator">*</span>tile_data <span class="token operator">=</span></span><br><span class="highlight-line">  <span class="token operator">&amp;</span>video_ram<span class="token punctuation">[</span><span class="token punctuation">(</span>LCDC <span class="token operator">&amp;</span> <span class="token number">16</span> <span class="token operator">?</span> tile <span class="token operator">:</span> <span class="token number">256</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int8_t</span><span class="token punctuation">)</span>tile<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span></span><br><span class="highlight-line">             y_offset <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>This gives us the low byte of this row in <code>tile_data[0]</code> and the high byte in
<code>tile_data[1]</code>. <code>x_offset &amp; 7</code> will give us the offset of the current pixel in
this tile's row. However, you may have noticed above that a tile's row has the
leftmost pixel as the most-significant bit. So, for example, if we are at pixel
offset 0, we want to use bit 7 of the row. This means that the amount to
shift right is actually <code>7 - x_offset</code>, which is the same as <code>x_offset ^ 7</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">x_offset <span class="token operator">=</span> <span class="token punctuation">(</span>x_offset <span class="token operator">^</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">uint8_t</span> color <span class="token operator">=</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>tile_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>></span> x_offset<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token operator">*</span>tile_data <span class="token operator">>></span> x_offset<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span></code></pre>
<p>Let's say we're drawing the fifth pixel of the second row of Ash's pokéball:</p>
<table>
<thead>
<tr>
<th>Byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal3 pokeborder">1 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>High <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal0 pokeborder">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Then <code>x_offset</code> is 3, so when we shift right by 3, we get:</p>
<table>
<thead>
<tr>
<th>Byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal0">0 <td class="pokepal3 pokeborder">1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>High <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3">1 <td class="pokepal3">1 <td class="pokepal0 pokeborder">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Then we perform <code>% 2</code>:</p>
<table>
<thead>
<tr>
<th>Byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>Low <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3 pokeborder">1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>High <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0 pokeborder">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>And then we shift the high byte left by 1, and add the bytes together:</p>
<table>
<thead>
<tr>
<th>Byte</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>Both <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal0">0 <td class="pokepal3 pokeborder">1 <td class="pokepal0 pokeborder">0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>This gives us a final color of 2.</p>
<p>After we've calculated the background or window pixel color, we may have to
draw a sprite on top of it. Sprites can be enabled or disabled with bit 1 of
<code>LCDC</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>LCDC <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span></code></pre>
<p>OAM has enough space for 40 sprites, each one requiring 4 bytes. On a real
gameboy only 10 sprites can be drawn per scanline, but we'll ignore that
limit. OAM starts at the beginning of <code>io</code> (address <code>$FE00-$FE9F</code>).</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span>sprite <span class="token operator">=</span> io<span class="token punctuation">;</span> sprite <span class="token operator">&lt;</span> io <span class="token operator">+</span> <span class="token number">160</span><span class="token punctuation">;</span> sprite <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>The sprite's coordinate is <code>(sprite[1] - 8, sprite[0] - 16)</code>. Similar to the
background tile, we can find which row and column of the sprite tile by
subtracting the current pixel's coordinate from the sprite's. The sprite's tile
is drawn if the x- and y-offset are both less than 8:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> sprite_x <span class="token operator">=</span> tmp <span class="token operator">-</span> sprite<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        sprite_y <span class="token operator">=</span> LY <span class="token operator">-</span> <span class="token operator">*</span>sprite <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>sprite_x <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> sprite_y <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>As with the background tile, we want to xor the x-offset with 7 so the
most-significant bit is also the leftmost bit. However, a sprite can also be
flipped horizontally if bit 5 of <code>sprite[3]</code> is set. In that case we can
leave the x-offset as it is by xor'ing it with 0:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">sprite_x <span class="token operator">^=</span> sprite<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">32</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">;</span></span></code></pre>
<p>Again, like background tiles, we want to fetch the tile data row for this
sprite. The sprite's tile is in <code>sprite[2]</code>. The sprite can also be flipped
vertically, so we xor the sprite's y-offset with 7 if bit 6 of <code>sprite[3]</code>
is set.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">tile_data <span class="token operator">=</span></span><br><span class="highlight-line">    <span class="token operator">&amp;</span>video_ram<span class="token punctuation">[</span>sprite<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span></span><br><span class="highlight-line">               <span class="token punctuation">(</span>sprite_y <span class="token operator">^</span> <span class="token punctuation">(</span>sprite<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">64</span> <span class="token operator">?</span> <span class="token number">7</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>We can then extract the color of the sprite's pixel:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">uint8_t</span> sprite_color <span class="token operator">=</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span>tile_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>></span> sprite_x<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token operator">*</span>tile_data <span class="token operator">>></span> sprite_x<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span></span></code></pre>
<p>A sprite's pixel is only drawn if the sprite's pixel is non-transparent. In
addition, the background pixel also must be transparent or the sprite must have
priority over the background for the sprite's pixel to be drawn. In other
words, if the background pixel is non-transparent and the sprite doesn't have
priority, then the sprite's pixel will <em>not</em> be drawn.</p>
<p>The sprite priority is bit 7 of <code>sprite[3]</code>; if it is 1, then the sprite is
drawn behind the background.</p>
<p>The sprite can use one of two palettes, <code>OBP0</code> and <code>OBP1</code>. If bit 3 of
<code>sprite[3]</code> is 1, then palette <code>OBP1</code> is used. We want <code>palette_index</code> to be
1 for <code>OBP0</code> and 2 for <code>OBP1</code>, so we add one to the value. <code>!!</code> is a little
trick to convert a non-zero value to 1:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sprite<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> color<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sprite_color<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  color <span class="token operator">=</span> sprite_color<span class="token punctuation">;</span></span><br><span class="highlight-line">  palette_index <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>sprite<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Now that we know the <code>color</code> and <code>palette_index</code>, we can look it up in the
<code>palette</code> to find the actual <code>RGBA</code> color to draw. Each palette is a single
byte, stored like this:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Address</th>
<th><code>io</code> offset</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody>
<tr>
<td>BGP</td>
<td>$FF47</td>
<td>327 <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OBP0</td>
<td>$FF48</td>
<td>328 <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OBP1</td>
<td>$FF49</td>
<td>329 <td colspan=2 class="td-colspan"> color 3 <td colspan=2 class="td-colspan"> color 2 <td colspan=2 class="td-colspan"> color 1 <td colspan=2 class="td-colspan"> color 0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Adding 327 to <code>palette_index</code> gives us the offset in <code>io</code> for the palette. We
can then shift the palette byte to the right by <code>2 * color</code> to isolate the
palette entry we want.</p>
<p>We'll write the final <code>RGBA</code> color into the frame buffer at the current pixel's
x- and y-coordinate, <code>(tmp, LY)</code>.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">frame_buffer<span class="token punctuation">[</span>LY <span class="token operator">*</span> <span class="token number">160</span> <span class="token operator">+</span> tmp<span class="token punctuation">]</span> <span class="token operator">=</span></span><br><span class="highlight-line">    palette<span class="token punctuation">[</span><span class="token punctuation">(</span>io<span class="token punctuation">[</span><span class="token number">327</span> <span class="token operator">+</span> palette_index<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">+</span></span><br><span class="highlight-line">            palette_index <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p><img src="/assets/2021-06-03-pokegb10.gif" alt="pacing-gif"></p>
<h3>Rendering with SDL</h3>
<p>Once we've finished drawing all the lines, we can finally draw the framebuffer
to the window! First we have to lock the texture that we created before, so we
have access to its pixels. The <code>tmp</code> parameter stores the pitch of the texture,
i.e. the width of a row of the texture in bytes, which may include extra
padding.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">void</span> <span class="token operator">*</span>pixels<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">SDL_LockTexture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pixels<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>For each row of the frame buffer, we copy it into the texture. The total number
of bytes copied per row is <code>160 * 4 == 640</code>, since an <code>RGBA</code> pixel is 4
bytes:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span>tmp2 <span class="token operator">=</span> <span class="token number">144</span><span class="token punctuation">;</span> <span class="token operator">--</span>tmp2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>pixels <span class="token operator">+</span> tmp2 <span class="token operator">*</span> tmp<span class="token punctuation">,</span> frame_buffer <span class="token operator">+</span> tmp2 <span class="token operator">*</span> <span class="token number">160</span><span class="token punctuation">,</span></span><br><span class="highlight-line">         <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Then we unlock the texture, render it to the window's back buffer, and then
present it to the screen:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line"><span class="token function">SDL_UnlockTexture</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">SDL_RenderCopy</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">SDL_RenderPresent</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>As the very final step, we poll for events, checking to see if the user quit.
This also updates <code>key_state</code>, so we can read from it directly.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="highlight-line">SDL_Event event<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SDL_PollEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">==</span> SDL_QUIT<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span></code></pre>
<p><img src="/assets/2021-06-03-pokegb9.gif" alt="title-scroll-gif"></p>
<h2>Formatting the Code</h2>
<p>Before I sent the tweet, I wanted to make the code look cool. I remember
looking at some examples from the <a href="https://www.ioccc.org/">IOCCC</a> and thought I'd take a chance at
formatting the code into a picture. See, for example, <a href="https://www.ioccc.org/2020/yang/index.html">Don Yang's winning
entry</a> from the 2020 competition:</p>
<p><img src="/assets/2021-06-03-ioccc-2020-yang.png" alt="ioccc-yang-png"></p>
<p>To start, I took the source code I had, and renamed all the variables to single
letter names, where possible. I then removed all whitespace to see how many
characters I was using, which was 4150 bytes, not including the <code>#include</code> and
<code>#define</code> lines.</p>
<p>My first thought was to use the Pokemon logo itself. I tried to make a good 1
bit-per-pixel version, but it ended up looking like garbage when I tried to fit
the source code to it:</p>
<p><img src="/assets/2021-06-03-pokemon-logo.png" alt="pokemon-logo-png"></p>
<p>My next thought was to use a single pokéball. I used the awesome <a href="https://www.desmos.com/calculator">Desmos online
calculator</a> to try to figure out how big each circle should be
interactively:</p>
<p><img src="/assets/2021-06-03-desmos.png" alt="desmos-png"></p>
<p>This looks pretty good, but it's a very large pokéball with a diameter of 96. I
realized that three pokéballs side-by-side would probably work better, giving a
width of 150 and a height of 50:</p>
<p><img src="/assets/2021-06-03-desmos2.png" alt="desmos2-png"></p>
<p>I then recreated as a 150x50 pixel image so that I could convert it to text and
use it as a guide for my source code layout:</p>
<p><img src="/assets/2021-06-03-3pokeballs.png" alt="3pokeballs-png"></p>
<p>The result ends up stretched vertically, since most fonts are taller than they
are wide, but I still think it looks good! Maybe next time I'll try to take
that into account.</p>
<p><img src="/assets/2021-06-03-ascii-pokeballs.png" alt="ascii-pokeballs-png"></p>
<p><img src="/assets/2021-06-03-pokegb4.gif" alt="fight-win-gif"></p>
<h2>Conclusion</h2>
<p>I had a lot of fun making pokegb, and I hope you enjoyed reading about it! If I
left anything out or made any mistakes, feel free to send me a message on
twitter <a href="https://twitter.com/binjimint">@binjimint</a>. Thanks to everyone on the <a href="https://discord.com/invite/AcqzxjpX">emudev discord</a> and the
<a href="https://discord.com/invite/tKGMPNr">gbdev discord</a> for making such a great community. Cheers!</p>

  </div>
</article>

      </div>
    </main>

    <footer class="site-footer">
      <div class="wrapper">
        <div class="footer-wrapper">
          <ul class="footer">
            <li>
              by ben smith
            </li>
            <li>
              <a href="https://github.com/binji"><span class="icon icon--github"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">binji</span></a>

              <a href="https://twitter.com/binjimint"><span class="icon icon--twitter"><svg viewbox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">binjimint</span></a>

            </li>
          </div>
        <div>
        <div class="footer-col-wrapper">
        </div>
      </div>
    </footer>
  </body>
</html>
